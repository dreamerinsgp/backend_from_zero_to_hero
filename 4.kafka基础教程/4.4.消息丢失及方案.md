# æ¶ˆæ¯ä¸¢å¤±åŠè§£å†³æ–¹æ¡ˆ

---

## Q1: æ¶ˆæ¯ä¸ºä»€ä¹ˆä¼šä¸¢å¤±ï¼Ÿ

æ¶ˆæ¯ä¸¢å¤±å¯èƒ½å‘ç”Ÿåœ¨ Kafka çš„ä¸‰ä¸ªç¯èŠ‚ï¼š**ç”Ÿäº§è€…ï¼ˆProducerï¼‰**ã€**æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰** å’Œ **Brokerï¼ˆKafka é›†ç¾¤ï¼‰**ã€‚

### 1. ç”Ÿäº§è€…ï¼ˆProducerï¼‰ç«¯æ¶ˆæ¯ä¸¢å¤±

#### åŸå›  1ï¼š`acks` é…ç½®ä¸å½“

**`acks=0`**ï¼šç”Ÿäº§è€…ä¸ç­‰å¾… Broker ç¡®è®¤

```
åœºæ™¯ï¼š
1. Producer å‘é€æ¶ˆæ¯åˆ° Broker
2. ä¸ç­‰å¾…ç¡®è®¤ï¼Œç«‹å³è¿”å›
3. Broker å´©æºƒæˆ–ç½‘ç»œé—®é¢˜
4. æ¶ˆæ¯æœªå†™å…¥ç£ç›˜ï¼Œä¸¢å¤±

é£é™©ï¼šæ¶ˆæ¯å¯èƒ½å®Œå…¨ä¸¢å¤±ï¼ŒProducer æ— æ³•æ„ŸçŸ¥
```

**`acks=1`**ï¼šåªç­‰å¾… Leader ç¡®è®¤

```
åœºæ™¯ï¼š
1. Producer å‘é€æ¶ˆæ¯åˆ° Leader
2. Leader å†™å…¥æœ¬åœ°æ—¥å¿—ï¼Œè¿”å›ç¡®è®¤
3. Leader å´©æºƒï¼ˆFollower å°šæœªåŒæ­¥ï¼‰
4. Follower è¢«é€‰ä¸¾ä¸ºæ–° Leader
5. æ¶ˆæ¯ä¸¢å¤±ï¼ˆæ–° Leader æ²¡æœ‰è¯¥æ¶ˆæ¯ï¼‰

é£é™©ï¼šLeader å´©æºƒæ—¶å¯èƒ½ä¸¢å¤±æ¶ˆæ¯
```

**é¡¹ç›®ä¸­çš„é…ç½®**ï¼š

**Market æœåŠ¡**ï¼ˆ`apps/market/internal/mqs/producer/producer.go`ï¼‰ï¼š
```go
config.Producer.RequiredAcks = sarama.WaitForLocal  // acks=1
```

**é£é™©**ï¼šå¦‚æœ Leader å´©æºƒï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ã€‚

#### åŸå›  2ï¼šå¼‚æ­¥å‘é€æœªå¤„ç†é”™è¯¯

**åœºæ™¯**ï¼šä½¿ç”¨ AsyncProducer å¼‚æ­¥å‘é€ï¼Œæœªç›‘å¬é”™è¯¯é€šé“ã€‚

```go
// é”™è¯¯çš„åšæ³•
producer.Input() <- message  // å‘é€åä¸æ£€æŸ¥é”™è¯¯
// å¦‚æœå‘é€å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤±ï¼Œä½† Producer ä¸çŸ¥é“
```

**é¡¹ç›®ä¸­çš„å®ç°**ï¼ˆ`apps/market/internal/mqs/producer/producer.go`ï¼‰ï¼š
```go
// æ­£ç¡®çš„åšæ³•ï¼šç›‘å¬é”™è¯¯é€šé“
go func() {
    for err := range producer.Errors() {
        logx.Errorf("Kafka producer error: %v", err)
        // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¯•æˆ–å‘Šè­¦
    }
}()
```

#### åŸå›  3ï¼šProducer å´©æºƒ

**åœºæ™¯**ï¼šProducer å‘é€æ¶ˆæ¯åã€æ”¶åˆ°ç¡®è®¤å‰å´©æºƒã€‚

```
æ—¶é—´çº¿ï¼š
1. Producer å‘é€æ¶ˆæ¯ï¼ˆæœªæ”¶åˆ°ç¡®è®¤ï¼‰
2. Producer å´©æºƒ
3. æ¶ˆæ¯å¯èƒ½æœªå†™å…¥ Brokerï¼Œä¸¢å¤±
```

#### åŸå›  4ï¼šç½‘ç»œé—®é¢˜

**åœºæ™¯**ï¼šç½‘ç»œä¸­æ–­å¯¼è‡´æ¶ˆæ¯å‘é€å¤±è´¥ã€‚

```
1. Producer å‘é€æ¶ˆæ¯
2. ç½‘ç»œä¸­æ–­
3. æ¶ˆæ¯æœªåˆ°è¾¾ Broker
4. Producer æœªæ”¶åˆ°é”™è¯¯ï¼ˆå¦‚æœæœªå¯ç”¨é”™è¯¯ç›‘å¬ï¼‰
5. æ¶ˆæ¯ä¸¢å¤±
```

---

### 2. æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ç«¯æ¶ˆæ¯ä¸¢å¤±

#### åŸå›  1ï¼šè‡ªåŠ¨æäº¤ Offset çš„æ—¶æœºé—®é¢˜

**åœºæ™¯**ï¼šè‡ªåŠ¨æäº¤ Offset åœ¨æ¶ˆæ¯å¤„ç†å®Œæˆå‰æäº¤ã€‚

```
æ—¶é—´çº¿ï¼š
1. Consumer æ‹‰å–æ¶ˆæ¯ï¼ˆOffset: 100-199ï¼‰
2. å¤„ç†æ¶ˆæ¯ï¼ˆOffset: 100-150ï¼‰
3. è‡ªåŠ¨æäº¤ Offsetï¼ˆæäº¤åˆ° 200ï¼‰â† æäº¤äº†æœªå¤„ç†çš„æ¶ˆæ¯
4. Consumer å´©æºƒ

ç»“æœï¼š
- Offset 151-199 çš„æ¶ˆæ¯è¢«è·³è¿‡ï¼Œä¸¢å¤±
- Consumer é‡å¯åä» Offset 200 ç»§ç»­æ¶ˆè´¹
```

**é¡¹ç›®ä¸­çš„é…ç½®**ï¼š

**go-queue/kq åº“**é»˜è®¤ä½¿ç”¨è‡ªåŠ¨æäº¤ï¼š
- æ¶ˆæ¯å¤„ç†æˆåŠŸåï¼ˆ`Consume` æ–¹æ³•è¿”å› `nil`ï¼‰è‡ªåŠ¨æäº¤ Offset
- å¦‚æœå¤„ç†å¤±è´¥ï¼ˆè¿”å›é”™è¯¯ï¼‰ï¼ŒOffset ä¸ä¼šè¢«æäº¤

**é£é™©**ï¼šå¦‚æœè‡ªåŠ¨æäº¤æ—¶æœºä¸å½“ï¼Œå¯èƒ½ä¸¢å¤±æ¶ˆæ¯ã€‚

#### åŸå›  2ï¼šConsumer å¤„ç†å¤±è´¥ä½† Offset å·²æäº¤

**åœºæ™¯**ï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œä½† Offset å·²ç»è¢«æäº¤ã€‚

```
æ—¶é—´çº¿ï¼š
1. Consumer æ‹‰å–æ¶ˆæ¯ï¼ˆOffset: 100ï¼‰
2. è‡ªåŠ¨æäº¤ Offsetï¼ˆæäº¤åˆ° 101ï¼‰
3. å¤„ç†æ¶ˆæ¯å¤±è´¥
4. Consumer ç»§ç»­æ¶ˆè´¹ä¸‹ä¸€æ¡æ¶ˆæ¯

ç»“æœï¼šOffset 100 çš„æ¶ˆæ¯ä¸¢å¤±ï¼Œä¸ä¼šè¢«é‡è¯•
```

#### åŸå›  3ï¼šConsumer å´©æºƒ

**åœºæ™¯**ï¼šConsumer å¤„ç†æ¶ˆæ¯åã€æäº¤ Offset å‰å´©æºƒã€‚

```
æ—¶é—´çº¿ï¼š
1. Consumer æ‹‰å–æ¶ˆæ¯ï¼ˆOffset: 100ï¼‰
2. å¤„ç†æ¶ˆæ¯ï¼ˆæ›´æ–°æ•°æ®åº“ï¼‰
3. Consumer å´©æºƒï¼ˆæœªæäº¤ Offsetï¼‰
4. Consumer é‡å¯
5. ä» Offset 100 é‡æ–°æ¶ˆè´¹ï¼ˆå¯èƒ½é‡å¤å¤„ç†ï¼Œä½†ä¸ä¼šä¸¢å¤±ï¼‰

æ³¨æ„ï¼šè¿™ç§æƒ…å†µä¸‹æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œä½†å¯èƒ½é‡å¤æ¶ˆè´¹
```

#### åŸå›  4ï¼šRebalance å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±

**åœºæ™¯**ï¼šRebalance æœŸé—´ï¼ŒConsumer å·²å¤„ç†æ¶ˆæ¯ä½†æœªæäº¤ Offsetã€‚

```
åˆå§‹çŠ¶æ€ï¼š
- Consumer 1 â†’ Partition 0 (Offset: 100)
- Consumer 2 â†’ Partition 1

Rebalance è§¦å‘ï¼š
1. Consumer 1 å¤„ç†æ¶ˆæ¯ï¼ˆOffset: 100-150ï¼‰
2. æœªæäº¤ Offset
3. Rebalance å®Œæˆ
4. Partition 0 åˆ†é…ç»™ Consumer 2
5. Consumer 2 ä» Offset 100 å¼€å§‹æ¶ˆè´¹

ç»“æœï¼šå¦‚æœ Consumer 1 çš„å¤„ç†ç»“æœæœªä¿å­˜ï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±
```

---

### 3. Brokerï¼ˆKafka é›†ç¾¤ï¼‰ç«¯æ¶ˆæ¯ä¸¢å¤±

#### åŸå›  1ï¼šå‰¯æœ¬åŒæ­¥å¤±è´¥

**åœºæ™¯**ï¼šLeader å†™å…¥æ¶ˆæ¯ï¼Œä½† Follower æœªåŒæ­¥å®Œæˆã€‚

```
åœºæ™¯ï¼š
1. Producer å‘é€æ¶ˆæ¯åˆ° Leaderï¼ˆacks=1ï¼‰
2. Leader å†™å…¥æœ¬åœ°æ—¥å¿—ï¼Œè¿”å›ç¡®è®¤
3. Follower åŒæ­¥å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ã€ç£ç›˜æ•…éšœç­‰ï¼‰
4. Leader å´©æºƒ
5. Follower è¢«é€‰ä¸¾ä¸ºæ–° Leaderï¼ˆæ²¡æœ‰è¯¥æ¶ˆæ¯ï¼‰
6. æ¶ˆæ¯ä¸¢å¤±
```

#### åŸå›  2ï¼šç£ç›˜æ•…éšœ

**åœºæ™¯**ï¼šBroker ç£ç›˜æ•…éšœï¼Œæ•°æ®æœªå¤‡ä»½ã€‚

```
1. Broker å†™å…¥æ¶ˆæ¯åˆ°ç£ç›˜
2. ç£ç›˜æ•…éšœ
3. å¦‚æœå‰¯æœ¬æ•° < 2ï¼Œæ¶ˆæ¯ä¸¢å¤±
```

#### åŸå›  3ï¼š`min.insync.replicas` é…ç½®ä¸å½“

**åœºæ™¯**ï¼šISRï¼ˆIn-Sync Replicasï¼‰æ•°é‡ä¸è¶³ã€‚

```
é…ç½®ï¼š
- replication.factor = 3
- min.insync.replicas = 1  â† é…ç½®ä¸å½“

åœºæ™¯ï¼š
1. Producer å‘é€æ¶ˆæ¯ï¼ˆacks=allï¼‰
2. Leader å†™å…¥ï¼Œç­‰å¾… ISR ç¡®è®¤
3. åªæœ‰ 1 ä¸ª ISRï¼ˆLeader è‡ªå·±ï¼‰
4. Leader å´©æºƒ
5. å¦‚æœå…¶ä»– Follower æœªåŒæ­¥ï¼Œæ¶ˆæ¯ä¸¢å¤±
```

---

## Q2: å¦‚ä½•ä¿éšœä¸ä¸¢å¤±ï¼Ÿ

### 1. ç”Ÿäº§è€…ï¼ˆProducerï¼‰ç«¯ä¿éšœ

#### æ–¹æ¡ˆ 1ï¼šè®¾ç½® `acks=all`

**åŸç†**ï¼šç­‰å¾…æ‰€æœ‰ ISRï¼ˆIn-Sync Replicasï¼‰ç¡®è®¤ï¼Œç¡®ä¿æ¶ˆæ¯å†™å…¥å¤šä¸ªå‰¯æœ¬ã€‚

**é…ç½®**ï¼š

```go
// ä½¿ç”¨ sarama åº“
config.Producer.RequiredAcks = sarama.WaitForAll  // acks=all
```

**Java é…ç½®**ï¼š
```properties
acks=all
```

**ä¼˜ç‚¹**ï¼š
- âœ… **æœ€é«˜å¯é æ€§**ï¼šç¡®ä¿æ¶ˆæ¯å†™å…¥å¤šä¸ªå‰¯æœ¬
- âœ… **é˜²æ­¢ Leader å´©æºƒä¸¢å¤±**ï¼šå³ä½¿ Leader å´©æºƒï¼ŒFollower ä¹Ÿæœ‰æ¶ˆæ¯

**ç¼ºç‚¹**ï¼š
- âš ï¸ **æ€§èƒ½è¾ƒä½**ï¼šéœ€è¦ç­‰å¾…å¤šä¸ªå‰¯æœ¬ç¡®è®¤
- âš ï¸ **å»¶è¿Ÿè¾ƒé«˜**ï¼šç½‘ç»œå»¶è¿Ÿä¼šå¢åŠ 

**é¡¹ç›®ä¸­çš„å»ºè®®**ï¼š

**Consumer æœåŠ¡**ï¼ˆåŒæ­¥å‘é€ï¼Œå…³é”®æ•°æ®ï¼‰ï¼š
```go
// å»ºè®®ä¿®æ”¹ä¸º
config.Producer.RequiredAcks = sarama.WaitForAll  // æé«˜å¯é æ€§
```

**Market æœåŠ¡**ï¼ˆå¼‚æ­¥å‘é€ï¼Œå¯å®¹å¿å°‘é‡ä¸¢å¤±ï¼‰ï¼š
```go
// å½“å‰é…ç½®ï¼šacks=1
config.Producer.RequiredAcks = sarama.WaitForLocal
// å¦‚æœæ•°æ®é‡è¦ï¼Œå»ºè®®æ”¹ä¸º acks=all
```

#### æ–¹æ¡ˆ 2ï¼šå¯ç”¨é‡è¯•æœºåˆ¶

**åŸç†**ï¼šå‘é€å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæé«˜æˆåŠŸç‡ã€‚

**é¡¹ç›®ä¸­çš„é…ç½®**ï¼š

**Consumer æœåŠ¡**ï¼ˆ`apps/consumer/internal/logic/mq/producer.go`ï¼‰ï¼š
```go
config.Producer.Retry.Max = 3
config.Producer.Retry.Backoff = 100 * time.Millisecond
```

**Market æœåŠ¡**ï¼ˆ`apps/market/internal/mqs/producer/producer.go`ï¼‰ï¼š
```go
config.Producer.Retry.Max = 3
config.Producer.Retry.Backoff = 100 * time.Millisecond
```

**ä¼˜ç‚¹**ï¼š
- âœ… **è‡ªåŠ¨é‡è¯•**ï¼šç½‘ç»œä¸´æ—¶æ•…éšœæ—¶è‡ªåŠ¨é‡è¯•
- âœ… **æé«˜æˆåŠŸç‡**ï¼šå‡å°‘å› ä¸´æ—¶æ•…éšœå¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±

**å»ºè®®**ï¼š
- å¯¹äºå…³é”®æ•°æ®ï¼Œå¯ä»¥å¢åŠ é‡è¯•æ¬¡æ•°ï¼š`Retry.Max = 5` æˆ–æ›´é«˜
- è®¾ç½®åˆç†çš„é‡è¯•é—´éš”ï¼š`Retry.Backoff = 100ms`

#### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨åŒæ­¥å‘é€

**åŸç†**ï¼šåŒæ­¥å‘é€ä¼šç­‰å¾…ç¡®è®¤ï¼Œç¡®ä¿æ¶ˆæ¯å‘é€æˆåŠŸã€‚

**é¡¹ç›®ä¸­çš„å®ç°**ï¼š

**Consumer æœåŠ¡**ï¼ˆ`apps/consumer/internal/logic/mq/producer.go`ï¼‰ï¼š
```go
// ä½¿ç”¨ SyncProducer
producer, err := sarama.NewSyncProducer(brokers, config)

// åŒæ­¥å‘é€ï¼Œç­‰å¾…ç¡®è®¤
p, o, err := producer.SendMessage(message)
if err != nil {
    logx.Errorf("send failed: %v", err)
    return err
}
logx.Infof("send success: partition=%d, offset=%d", p, o)
```

**ä¼˜ç‚¹**ï¼š
- âœ… **ç«‹å³æ„ŸçŸ¥é”™è¯¯**ï¼šå‘é€å¤±è´¥ç«‹å³è¿”å›é”™è¯¯
- âœ… **å¯ä»¥é‡è¯•**ï¼šå¯ä»¥åœ¨åº”ç”¨å±‚å®ç°é‡è¯•é€»è¾‘

**ç¼ºç‚¹**ï¼š
- âš ï¸ **æ€§èƒ½è¾ƒä½**ï¼šéœ€è¦ç­‰å¾…ç¡®è®¤
- âš ï¸ **ååé‡è¾ƒä½**ï¼šä¸é€‚åˆé«˜åååœºæ™¯

#### æ–¹æ¡ˆ 4ï¼šç›‘å¬é”™è¯¯é€šé“ï¼ˆå¼‚æ­¥å‘é€ï¼‰

**åŸç†**ï¼šå¼‚æ­¥å‘é€æ—¶ç›‘å¬é”™è¯¯é€šé“ï¼Œå¤„ç†å‘é€å¤±è´¥çš„æƒ…å†µã€‚

**é¡¹ç›®ä¸­çš„å®ç°**ï¼ˆ`apps/market/internal/mqs/producer/producer.go`ï¼‰ï¼š
```go
// ç›‘å¬é”™è¯¯é€šé“
go func() {
    for err := range producer.Errors() {
        logx.Errorf("Kafka producer error: %v", err)
        // å¯ä»¥åœ¨è¿™é‡Œå®ç°ï¼š
        // 1. é‡è¯•é€»è¾‘
        // 2. å‘Šè­¦é€šçŸ¥
        // 3. è®°å½•åˆ°æ­»ä¿¡é˜Ÿåˆ—
    }
}()
```

**ä¼˜ç‚¹**ï¼š
- âœ… **ä¸é˜»å¡ä¸»æµç¨‹**ï¼šå¼‚æ­¥å¤„ç†é”™è¯¯
- âœ… **å¯ä»¥é‡è¯•**ï¼šåœ¨é”™è¯¯å¤„ç†ä¸­å®ç°é‡è¯•

**å»ºè®®**ï¼š
- å®ç°é‡è¯•é€»è¾‘ï¼šå¤±è´¥åé‡æ–°å‘é€
- å®ç°å‘Šè­¦æœºåˆ¶ï¼šå¤šæ¬¡å¤±è´¥åå‘Šè­¦
- è®°å½•å¤±è´¥æ¶ˆæ¯ï¼šä¿å­˜åˆ°æ•°æ®åº“æˆ–æ­»ä¿¡é˜Ÿåˆ—

#### æ–¹æ¡ˆ 5ï¼šå¯ç”¨å¹‚ç­‰æ€§ Producer

**åŸç†**ï¼šKafka 0.11+ æ”¯æŒå¹‚ç­‰æ€§ Producerï¼Œé˜²æ­¢é‡å¤æ¶ˆæ¯ã€‚

**é…ç½®**ï¼š

```go
config.Producer.Idempotent = true
config.Producer.RequiredAcks = sarama.WaitForAll
config.Net.MaxOpenRequests = 1  // å¿…é¡»è®¾ç½®ä¸º 1
```

**ä¼˜ç‚¹**ï¼š
- âœ… **é˜²æ­¢é‡å¤æ¶ˆæ¯**ï¼šå³ä½¿é‡è¯•ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿé‡å¤æ¶ˆæ¯
- âœ… **æé«˜å¯é æ€§**ï¼šä¸ acks=all é…åˆä½¿ç”¨

---

### 2. æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ç«¯ä¿éšœ

#### æ–¹æ¡ˆ 1ï¼šæ‰‹åŠ¨æäº¤ Offset

**åŸç†**ï¼šæ¶ˆæ¯å¤„ç†æˆåŠŸåå†æäº¤ Offsetï¼Œç¡®ä¿ä¸ä¸¢å¤±ã€‚

**å®ç°**ï¼š

```go
func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. å¤„ç†æ¶ˆæ¯
    var tradeMsg []*model.TradeWithPair
    if err := json.Unmarshal(key.Value, &tradeMsg); err != nil {
        return err  // è¿”å›é”™è¯¯ï¼ŒOffset ä¸ä¼šè¢«æäº¤
    }
    
    // 2. ä¸šåŠ¡å¤„ç†
    if err := t.processTrade(ctx, tradeMsg); err != nil {
        return err  // å¤„ç†å¤±è´¥ï¼ŒOffset ä¸ä¼šè¢«æäº¤
    }
    
    // 3. å¤„ç†æˆåŠŸï¼Œè¿”å› nilï¼ŒOffset ä¼šè¢«æäº¤
    return nil
}
```

**é¡¹ç›®ä¸­çš„å®ç°**ï¼š

**go-queue/kq åº“**ï¼š
- `Consume` æ–¹æ³•è¿”å› `nil`ï¼šOffset è‡ªåŠ¨æäº¤
- `Consume` æ–¹æ³•è¿”å›é”™è¯¯ï¼šOffset ä¸æäº¤ï¼Œæ¶ˆæ¯ä¼šè¢«é‡è¯•

**ä¼˜ç‚¹**ï¼š
- âœ… **ç²¾ç¡®æ§åˆ¶**ï¼šåªæœ‰å¤„ç†æˆåŠŸæ‰æäº¤ Offset
- âœ… **é˜²æ­¢ä¸¢å¤±**ï¼šå¤„ç†å¤±è´¥æ—¶ Offset ä¸æäº¤ï¼Œæ¶ˆæ¯ä¼šè¢«é‡è¯•

#### æ–¹æ¡ˆ 2ï¼šå¤„ç†æˆåŠŸåå†æäº¤ Offset

**åŸç†**ï¼šç¡®ä¿ä¸šåŠ¡é€»è¾‘æ‰§è¡ŒæˆåŠŸåå†æäº¤ Offsetã€‚

**å®ç°**ï¼š

```go
func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. ååºåˆ—åŒ–
    var tradeMsg []*model.TradeWithPair
    if err := json.Unmarshal(key.Value, &tradeMsg); err != nil {
        return err
    }
    
    // 2. ä¿å­˜åˆ°æ•°æ®åº“
    if err := t.saveToDatabase(ctx, tradeMsg); err != nil {
        return err  // ä¿å­˜å¤±è´¥ï¼ŒOffset ä¸æäº¤
    }
    
    // 3. å‘é€åˆ° Redis
    if err := t.saveToRedis(ctx, tradeMsg); err != nil {
        return err  // ä¿å­˜å¤±è´¥ï¼ŒOffset ä¸æäº¤
    }
    
    // 4. æ‰€æœ‰æ“ä½œæˆåŠŸï¼Œè¿”å› nilï¼ŒOffset æäº¤
    return nil
}
```

**é¡¹ç›®ä¸­çš„å®ç°**ï¼ˆ`apps/dataflow/internal/mqs/consumers/trade_consumer.go`ï¼‰ï¼š
```go
func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // å¤„ç†æ¶ˆæ¯
    // ...
    
    // å‘é€åˆ° Redisã€æ•°æ®åº“ã€WebSocket
    // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œè¿”å›é”™è¯¯ï¼ŒOffset ä¸æäº¤
    
    return nil  // æ‰€æœ‰æ“ä½œæˆåŠŸï¼ŒOffset æäº¤
}
```

#### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨äº‹åŠ¡æ€§æ¶ˆè´¹

**åŸç†**ï¼šä½¿ç”¨ Kafka äº‹åŠ¡ APIï¼Œç¡®ä¿æ¶ˆè´¹å’Œ Offset æäº¤çš„åŸå­æ€§ã€‚

**å®ç°**ï¼š

```go
// é…ç½® Consumer å¯ç”¨äº‹åŠ¡
config.Consumer.IsolationLevel = sarama.ReadCommitted

// åœ¨äº‹åŠ¡ä¸­å¤„ç†æ¶ˆæ¯å’Œæäº¤ Offset
producer.BeginTxn()
// å¤„ç†æ¶ˆæ¯
processMessage(message)
// æäº¤ Offset å’Œæ¶ˆæ¯åˆ°äº‹åŠ¡
producer.AddOffsetsToTxn(offsets, consumerGroupMetadata)
producer.CommitTxn()
```

**ä¼˜ç‚¹**ï¼š
- âœ… **åŸå­æ€§ä¿è¯**ï¼šæ¶ˆæ¯å¤„ç†å’Œ Offset æäº¤è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- âœ… **Exactly-once è¯­ä¹‰**ï¼šä¿è¯æ¶ˆæ¯åªè¢«å¤„ç†ä¸€æ¬¡

**ç¼ºç‚¹**ï¼š
- âš ï¸ **æ€§èƒ½å¼€é”€**ï¼šäº‹åŠ¡æœºåˆ¶æœ‰æ€§èƒ½å¼€é”€
- âš ï¸ **å¤æ‚åº¦é«˜**ï¼šéœ€è¦æ­£ç¡®é…ç½®å’Œç®¡ç†äº‹åŠ¡

---

### 3. Brokerï¼ˆKafka é›†ç¾¤ï¼‰ç«¯ä¿éšœ

#### æ–¹æ¡ˆ 1ï¼šè®¾ç½®åˆé€‚çš„å‰¯æœ¬æ•°

**åŸç†**ï¼šå¢åŠ å‰¯æœ¬æ•°ï¼Œæé«˜æ•°æ®å¯é æ€§ã€‚

**é…ç½®**ï¼š

```bash
# åˆ›å»º Topic æ—¶è®¾ç½®å‰¯æœ¬æ•°
kafka-topics.sh --create \
  --topic sol-trades \
  --partitions 3 \
  --replication-factor 3 \  # 3 ä¸ªå‰¯æœ¬
  --bootstrap-server localhost:9092
```

**å»ºè®®**ï¼š
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š`replication.factor >= 3`
- **æµ‹è¯•ç¯å¢ƒ**ï¼š`replication.factor >= 2`

**ä¼˜ç‚¹**ï¼š
- âœ… **é«˜å¯ç”¨æ€§**ï¼šå³ä½¿ 1-2 ä¸ª Broker å´©æºƒï¼Œæ•°æ®ä»ç„¶å¯ç”¨
- âœ… **é˜²æ­¢æ•°æ®ä¸¢å¤±**ï¼šå¤šä¸ªå‰¯æœ¬ä¿è¯æ•°æ®ä¸ä¸¢å¤±

#### æ–¹æ¡ˆ 2ï¼šè®¾ç½® `min.insync.replicas`

**åŸç†**ï¼šç¡®ä¿è‡³å°‘æœ‰æŒ‡å®šæ•°é‡çš„ ISR å‰¯æœ¬åŒæ­¥æ¶ˆæ¯ã€‚

**é…ç½®**ï¼š

```bash
# è®¾ç½® Topic çš„ min.insync.replicas
kafka-configs.sh --alter \
  --topic sol-trades \
  --add-config min.insync.replicas=2 \
  --bootstrap-server localhost:9092
```

**å»ºè®®**ï¼š
- **replication.factor = 3**ï¼š`min.insync.replicas = 2`
- **replication.factor = 5**ï¼š`min.insync.replicas = 3`

**å·¥ä½œåŸç†**ï¼š

```
é…ç½®ï¼š
- replication.factor = 3
- min.insync.replicas = 2

åœºæ™¯ï¼š
1. Producer å‘é€æ¶ˆæ¯ï¼ˆacks=allï¼‰
2. Leader å†™å…¥æ¶ˆæ¯
3. ç­‰å¾…è‡³å°‘ 2 ä¸ª ISR ç¡®è®¤ï¼ˆLeader + 1 ä¸ª Followerï¼‰
4. è¿”å›ç¡®è®¤ç»™ Producer

ä¼˜ç‚¹ï¼š
- å³ä½¿ 1 ä¸ª Broker å´©æºƒï¼Œæ¶ˆæ¯ä»ç„¶å¯ç”¨
- é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±
```

#### æ–¹æ¡ˆ 3ï¼šå¯ç”¨æ•°æ®æŒä¹…åŒ–

**åŸç†**ï¼šKafka é»˜è®¤å°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå³ä½¿ Broker é‡å¯ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

**é…ç½®**ï¼š

```properties
# Broker é…ç½®
log.flush.interval.messages=10000  # æ¯ 10000 æ¡æ¶ˆæ¯åˆ·æ–°ä¸€æ¬¡
log.flush.interval.ms=1000        # æ¯ 1 ç§’åˆ·æ–°ä¸€æ¬¡
```

**è¯´æ˜**ï¼š
- Kafka é»˜è®¤ä½¿ç”¨ `fsync` å°†æ•°æ®å†™å…¥ç£ç›˜
- å³ä½¿ Broker å´©æºƒï¼Œå·²å†™å…¥ç£ç›˜çš„æ•°æ®ä¸ä¼šä¸¢å¤±

---

### 4. é¡¹ç›®ä¸­çš„æœ€ä½³å®è·µ

#### å®è·µ 1ï¼šProducer é…ç½®å»ºè®®

**å…³é”®æ•°æ®ï¼ˆäº¤æ˜“æ•°æ®ï¼‰**ï¼š

```go
// Consumer æœåŠ¡ Producer é…ç½®
config.Producer.RequiredAcks = sarama.WaitForAll  // acks=all
config.Producer.Retry.Max = 5                     // å¢åŠ é‡è¯•æ¬¡æ•°
config.Producer.Retry.Backoff = 100 * time.Millisecond
config.Producer.Return.Successes = true           // ç›‘å¬æˆåŠŸ
config.Producer.Return.Errors = true              // ç›‘å¬é”™è¯¯
```

**éå…³é”®æ•°æ®ï¼ˆK çº¿æ•°æ®ï¼‰**ï¼š

```go
// Market æœåŠ¡ Producer é…ç½®ï¼ˆå½“å‰ï¼‰
config.Producer.RequiredAcks = sarama.WaitForLocal  // acks=1
config.Producer.Retry.Max = 3
config.Producer.Retry.Backoff = 100 * time.Millisecond
config.Producer.Return.Errors = true  // ç›‘å¬é”™è¯¯
```

**å»ºè®®**ï¼š
- å¦‚æœ K çº¿æ•°æ®ä¹Ÿå¾ˆé‡è¦ï¼Œå»ºè®®æ”¹ä¸º `acks=all`
- å¢åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘

#### å®è·µ 2ï¼šConsumer é…ç½®å»ºè®®

**é¡¹ç›®ä¸­çš„å®ç°**ï¼ˆä½¿ç”¨ go-queue/kq åº“ï¼‰ï¼š

```go
func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. å¤„ç†æ¶ˆæ¯
    // 2. å¦‚æœå¤±è´¥ï¼Œè¿”å›é”™è¯¯ï¼ˆOffset ä¸æäº¤ï¼‰
    // 3. å¦‚æœæˆåŠŸï¼Œè¿”å› nilï¼ˆOffset è‡ªåŠ¨æäº¤ï¼‰
    return nil
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… **è‡ªåŠ¨å¤„ç†**ï¼šåº“è‡ªåŠ¨å¤„ç† Offset æäº¤
- âœ… **é˜²æ­¢ä¸¢å¤±**ï¼šå¤„ç†å¤±è´¥æ—¶ Offset ä¸æäº¤

**å»ºè®®**ï¼š
- ç¡®ä¿æ‰€æœ‰å…³é”®æ“ä½œæˆåŠŸåå†è¿”å› `nil`
- ä½¿ç”¨äº‹åŠ¡æˆ–å¹‚ç­‰æ€§è®¾è®¡é˜²æ­¢é‡å¤å¤„ç†

#### å®è·µ 3ï¼šç›‘æ§å’Œå‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**ï¼š

1. **Producer é”™è¯¯ç‡**ï¼š
   ```go
   // ç›‘æ§ Producer é”™è¯¯
   for err := range producer.Errors() {
       metrics.IncProducerErrors()
       if metrics.GetProducerErrorRate() > 0.01 {  // é”™è¯¯ç‡ > 1%
           alert.Send("Producer error rate too high")
       }
   }
   ```

2. **Consumer Lag**ï¼š
   ```bash
   # ç›‘æ§ Consumer Group çš„ Lag
   kafka-consumer-groups.sh \
     --bootstrap-server localhost:9092 \
     --group data-flow-default-group-1888 \
     --describe
   ```

3. **æ¶ˆæ¯ä¸¢å¤±æ£€æµ‹**ï¼š
   - ç›‘æ§æ¶ˆæ¯çš„å‘é€å’Œæ¶ˆè´¹æ•°é‡
   - å¦‚æœæ¶ˆè´¹æ•°é‡ < å‘é€æ•°é‡ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±

---

## æ€»ç»“

### æ¶ˆæ¯ä¸¢å¤±çš„åŸå› 

| ç¯èŠ‚ | åŸå›  | é£é™©ç­‰çº§ |
|------|------|---------|
| **Producer** | `acks=0` æˆ– `acks=1` | ğŸ”´ é«˜ |
| **Producer** | å¼‚æ­¥å‘é€æœªå¤„ç†é”™è¯¯ | ğŸ”´ é«˜ |
| **Consumer** | è‡ªåŠ¨æäº¤ Offset æ—¶æœºä¸å½“ | ğŸŸ¡ ä¸­ |
| **Consumer** | å¤„ç†å¤±è´¥ä½† Offset å·²æäº¤ | ğŸŸ¡ ä¸­ |
| **Broker** | å‰¯æœ¬æ•°ä¸è¶³ | ğŸ”´ é«˜ |
| **Broker** | `min.insync.replicas` é…ç½®ä¸å½“ | ğŸŸ¡ ä¸­ |

### ä¿éšœæ¶ˆæ¯ä¸ä¸¢å¤±çš„æ–¹æ¡ˆ

| ç¯èŠ‚ | æ–¹æ¡ˆ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **Producer** | è®¾ç½® `acks=all` | â­â­â­â­â­ |
| **Producer** | å¯ç”¨é‡è¯•æœºåˆ¶ | â­â­â­â­ |
| **Producer** | ä½¿ç”¨åŒæ­¥å‘é€æˆ–ç›‘å¬é”™è¯¯ | â­â­â­â­ |
| **Consumer** | æ‰‹åŠ¨æäº¤ Offset | â­â­â­â­â­ |
| **Consumer** | å¤„ç†æˆåŠŸåå†æäº¤ | â­â­â­â­â­ |
| **Broker** | è®¾ç½® `replication.factor >= 3` | â­â­â­â­â­ |
| **Broker** | è®¾ç½® `min.insync.replicas >= 2` | â­â­â­â­ |

### é¡¹ç›®ä¸­çš„å»ºè®®

1. **Producer ç«¯**ï¼š
   - å…³é”®æ•°æ®ä½¿ç”¨ `acks=all`
   - å¢åŠ é‡è¯•æ¬¡æ•°å’Œé”™è¯¯å¤„ç†
   - ç›‘å¬é”™è¯¯é€šé“å¹¶å®ç°é‡è¯•

2. **Consumer ç«¯**ï¼š
   - ç¡®ä¿å¤„ç†æˆåŠŸåå†è¿”å› `nil`
   - ä½¿ç”¨å¹‚ç­‰æ€§è®¾è®¡é˜²æ­¢é‡å¤å¤„ç†
   - ç›‘æ§ Consumer Lag

3. **Broker ç«¯**ï¼š
   - è®¾ç½® `replication.factor >= 3`
   - è®¾ç½® `min.insync.replicas >= 2`
   - å®šæœŸæ£€æŸ¥å‰¯æœ¬åŒæ­¥çŠ¶æ€

---

## Q3: é¡¹ç›®ä¸­é‡‡ç”¨çš„ä¿éšœæ–¹æ¡ˆï¼Ÿ

é¡¹ç›®ä¸­é‡‡ç”¨äº†å¤šå±‚ä¿éšœæœºåˆ¶æ¥é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼Œæ¶µç›–äº† Producerã€Consumer å’Œä¸šåŠ¡é€»è¾‘ä¸‰ä¸ªå±‚é¢ã€‚

---

### 1. Producer ç«¯ä¿éšœæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šConsumer æœåŠ¡ - åŒæ­¥å‘é€ + é”™è¯¯å¤„ç†

**å®ç°ä½ç½®**ï¼š`apps/consumer/internal/logic/mq/producer.go`

**é…ç½®è¯¦æƒ…**ï¼š

```go
func newAccessLogProducer(brokers []string, _, username, password string) (sarama.SyncProducer, error) {
    config := sarama.NewConfig()
    
    // 1. é‡è¯•æœºåˆ¶
    config.Producer.Retry.Max = 3
    config.Producer.Retry.Backoff = 100 * time.Millisecond
    
    // 2. ç›‘å¬é”™è¯¯å’ŒæˆåŠŸ
    config.Producer.Return.Errors = true
    config.Producer.Return.Successes = true
    
    // 3. ä½¿ç”¨åŒæ­¥å‘é€
    producer, err := sarama.NewSyncProducer(brokers, config)
    
    return producer, nil
}
```

**å‘é€æ¶ˆæ¯**ï¼š

```go
func SendEventLogKafkaInfoMessage(topic string, key string, data []byte) error {
    message := &sarama.ProducerMessage{
        Topic: topic,
        Key:   &accessLogEntry{encoded: []byte(key)},
        Value: &accessLogEntry{encoded: data},
    }
    
    // åŒæ­¥å‘é€ï¼Œç­‰å¾…ç¡®è®¤
    p, o, err := _kafkaClient.SendMessage(message)
    if err != nil {
        logx.Errorf("[kafka] send event log to kafka failed: error:%v", err)
        return err  // è¿”å›é”™è¯¯ï¼Œè°ƒç”¨æ–¹å¯ä»¥é‡è¯•
    }
    
    logx.Infof("[kafka] send event log to kafka success: %v:%v:%v, %v, len(data): %v",
        topic, p, o, key, len(data))
    return nil
}
```

**ä¿éšœæªæ–½**ï¼š

| æªæ–½ | è¯´æ˜ | æ•ˆæœ |
|------|------|------|
| **åŒæ­¥å‘é€** | ä½¿ç”¨ `SyncProducer`ï¼Œç­‰å¾… Broker ç¡®è®¤ | âœ… ç«‹å³æ„ŸçŸ¥å‘é€å¤±è´¥ |
| **é‡è¯•æœºåˆ¶** | `Retry.Max = 3`ï¼Œè‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ¶ˆæ¯ | âœ… ç½‘ç»œä¸´æ—¶æ•…éšœæ—¶è‡ªåŠ¨é‡è¯• |
| **é”™è¯¯ç›‘å¬** | `Return.Errors = true`ï¼Œç›‘å¬å‘é€é”™è¯¯ | âœ… å¯ä»¥è®°å½•å’Œå‘Šè­¦ |
| **æˆåŠŸç¡®è®¤** | `Return.Successes = true`ï¼Œç¡®è®¤å‘é€æˆåŠŸ | âœ… è®°å½•å‘é€æˆåŠŸçš„æ¶ˆæ¯ |
| **é”™è¯¯è¿”å›** | å‘é€å¤±è´¥è¿”å›é”™è¯¯ï¼Œè°ƒç”¨æ–¹å¯ä»¥é‡è¯• | âœ… åº”ç”¨å±‚å¯ä»¥å†æ¬¡é‡è¯• |

**ä½¿ç”¨åœºæ™¯**ï¼š
- **äº¤æ˜“æ•°æ®å‘é€**ï¼š`sol-trades`ã€`sol-pair-price-change` ç­‰å…³é”®æ•°æ®
- **æ•°æ®é‡è¦æ€§**ï¼šé«˜ï¼ˆäº¤æ˜“æ•°æ®ä¸èƒ½ä¸¢å¤±ï¼‰

**æ³¨æ„**ï¼š
- âš ï¸ **æœªè®¾ç½® `acks=all`**ï¼šå½“å‰ä½¿ç”¨é»˜è®¤çš„ `acks=1`ï¼Œå¦‚æœ Leader å´©æºƒå¯èƒ½ä¸¢å¤±æ¶ˆæ¯
- ğŸ’¡ **å»ºè®®æ”¹è¿›**ï¼šå¯¹äºå…³é”®æ•°æ®ï¼Œå»ºè®®è®¾ç½® `config.Producer.RequiredAcks = sarama.WaitForAll`

---

#### æ–¹æ¡ˆ 2ï¼šMarket æœåŠ¡ - å¼‚æ­¥å‘é€ + é”™è¯¯ç›‘å¬

**å®ç°ä½ç½®**ï¼š`apps/market/internal/mqs/producer/producer.go`

**é…ç½®è¯¦æƒ…**ï¼š

```go
func newAccessLogProducer(brokers []string, username, password string) (sarama.AsyncProducer, error) {
    config := sarama.NewConfig()
    
    // 1. acks é…ç½®
    config.Producer.RequiredAcks = sarama.WaitForLocal  // acks=1
    
    // 2. é‡è¯•æœºåˆ¶
    config.Producer.Retry.Max = 3
    config.Producer.Retry.Backoff = 100 * time.Millisecond
    
    // 3. ç›‘å¬é”™è¯¯
    config.Producer.Return.Errors = true
    
    producer, err := sarama.NewAsyncProducer(brokers, config)
    
    // 4. å¯åŠ¨ goroutine ç›‘å¬é”™è¯¯
    go func() {
        for err := range producer.Errors() {
            logx.Errorf("Kafka producer error: %v", err)
            // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¯•æˆ–å‘Šè­¦
        }
    }()
    
    return producer, nil
}
```

**å‘é€æ¶ˆæ¯**ï¼š

```go
func SendMessage(topic string, key string, data []byte) error {
    if _kfakaClient == nil {
        return errors.New("_kfakaClient is Nil")
    }
    
    // å¼‚æ­¥å‘é€ï¼Œç«‹å³è¿”å›
    _kfakaClient.Input() <- &sarama.ProducerMessage{
        Topic: topic,
        Key:   &accessLogEntry{encoded: []byte(key)},
        Value: &accessLogEntry{encoded: data},
    }
    return nil
}
```

**ä¿éšœæªæ–½**ï¼š

| æªæ–½ | è¯´æ˜ | æ•ˆæœ |
|------|------|------|
| **å¼‚æ­¥å‘é€** | ä½¿ç”¨ `AsyncProducer`ï¼Œä¸é˜»å¡ä¸»æµç¨‹ | âœ… æé«˜ååé‡ |
| **é”™è¯¯ç›‘å¬** | å¯åŠ¨ goroutine ç›‘å¬é”™è¯¯é€šé“ | âœ… åŠæ—¶å‘ç°å‘é€å¤±è´¥ |
| **é‡è¯•æœºåˆ¶** | `Retry.Max = 3`ï¼Œè‡ªåŠ¨é‡è¯• | âœ… ç½‘ç»œæ•…éšœæ—¶è‡ªåŠ¨é‡è¯• |
| **acks=1** | ç­‰å¾… Leader ç¡®è®¤ | âœ… åŸºæœ¬çš„å¯é æ€§ä¿è¯ |

**ä½¿ç”¨åœºæ™¯**ï¼š
- **K çº¿æ•°æ®å‘é€**ï¼š`klines-{chainId}-{env}` ç­‰æ•°æ®
- **æ•°æ®é‡è¦æ€§**ï¼šä¸­ï¼ˆK çº¿æ•°æ®å¯ä»¥å®¹å¿å°‘é‡ä¸¢å¤±ï¼Œå› ä¸ºå¯ä»¥é‡æ–°ç”Ÿæˆï¼‰

**æ³¨æ„**ï¼š
- âš ï¸ **å¼‚æ­¥å‘é€**ï¼šå‘é€åç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…ç¡®è®¤
- âš ï¸ **é”™è¯¯å¤„ç†**ï¼šå½“å‰åªè®°å½•æ—¥å¿—ï¼Œæœªå®ç°é‡è¯•é€»è¾‘
- ğŸ’¡ **å»ºè®®æ”¹è¿›**ï¼š
  - åœ¨é”™è¯¯å¤„ç†ä¸­å®ç°é‡è¯•é€»è¾‘
  - å¯¹äºé‡è¦æ•°æ®ï¼Œè€ƒè™‘æ”¹ä¸º `acks=all`
  - å®ç°å‘Šè­¦æœºåˆ¶ï¼Œå¤šæ¬¡å¤±è´¥åå‘Šè­¦

---

### 2. Consumer ç«¯ä¿éšœæ–¹æ¡ˆ

#### æ–¹æ¡ˆï¼šgo-queue/kq åº“çš„è‡ªåŠ¨ Offset ç®¡ç†

**å®ç°ä½ç½®**ï¼š`apps/dataflow/internal/mqs/consumers/trade_consumer.go`

**å·¥ä½œåŸç†**ï¼š

```go
func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. ååºåˆ—åŒ–æ¶ˆæ¯
    var tradeMsg []*model.TradeWithPair
    if err := json.Unmarshal(key.Value, &tradeMsg); err != nil {
        logc.Errorf(ctx, "failed to unmarshal trade message: %+v", err)
        return err  // è¿”å›é”™è¯¯ï¼ŒOffset ä¸ä¼šè¢«æäº¤
    }
    
    // 2. ä¸šåŠ¡å¤„ç†
    klineMap := logic.GenerateKlinesWithTradesFromTrades(ctx, tradeMsg)
    
    // 3. ä¿å­˜åˆ° Redisã€æ•°æ®åº“ã€WebSocket
    for _, klineWithTrade := range klineMap {
        t.workerPool.Submit(func() {
            // å‘é€åˆ° Redis
            cache.KlineRedisCache.NewPush(ctx, k.Klines[i])
            
            // å‘é€åˆ°æ•°æ®åº“ï¼ˆæ‰¹é‡ï¼‰
            config.KlineProcessedCh <- klineData
            
            // å‘é€åˆ° WebSocket
            t.SendKlinesToWsServer(ctx, k)
        })
    }
    
    // 4. å¤„ç†æˆåŠŸï¼Œè¿”å› nil
    // kq åº“ä¼šè‡ªåŠ¨æäº¤ Offset
    return nil
}
```

**ä¿éšœæªæ–½**ï¼š

| æªæ–½ | è¯´æ˜ | æ•ˆæœ |
|------|------|------|
| **å¤„ç†æˆåŠŸæ‰æäº¤** | è¿”å› `nil` æ—¶ Offset æ‰è¢«æäº¤ | âœ… é˜²æ­¢æ¶ˆæ¯ä¸¢å¤± |
| **å¤„ç†å¤±è´¥ä¸æäº¤** | è¿”å›é”™è¯¯æ—¶ Offset ä¸æäº¤ | âœ… æ¶ˆæ¯ä¼šè¢«é‡è¯• |
| **è‡ªåŠ¨é‡è¯•** | Kafka ä¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ¶ˆæ¯ | âœ… æé«˜æˆåŠŸç‡ |
| **æ‰¹é‡å¤„ç†** | ä½¿ç”¨ worker pool å¹¶å‘å¤„ç† | âœ… æé«˜å¤„ç†é€Ÿåº¦ |

**Offset æäº¤æœºåˆ¶**ï¼š

```
1. Consumer æ‹‰å–æ¶ˆæ¯ï¼ˆOffset: 100ï¼‰
   â†“
2. è°ƒç”¨ Consume æ–¹æ³•å¤„ç†æ¶ˆæ¯
   â†“
3. å¦‚æœè¿”å› nilï¼ˆæˆåŠŸï¼‰
   â†’ kq åº“è‡ªåŠ¨æäº¤ Offset
   â†’ æ¶ˆæ¯ä¸ä¼šä¸¢å¤±
   â†“
4. å¦‚æœè¿”å›é”™è¯¯ï¼ˆå¤±è´¥ï¼‰
   â†’ Offset ä¸æäº¤
   â†’ æ¶ˆæ¯ä¼šè¢«é‡è¯•
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- **Dataflow æœåŠ¡**ï¼šæ¶ˆè´¹ `sol-trades`ã€`bsc-trades` ç­‰äº¤æ˜“æ•°æ®
- **Market æœåŠ¡**ï¼šæ¶ˆè´¹ `sol-trades`ã€`evm-trades-v4` ç­‰äº¤æ˜“æ•°æ®
- **Smart Money æœåŠ¡**ï¼šæ¶ˆè´¹ `sol-trades` äº¤æ˜“æ•°æ®

**ä¼˜ç‚¹**ï¼š
- âœ… **ç®€å•æ˜“ç”¨**ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç† Offset
- âœ… **è‡ªåŠ¨å¤„ç†**ï¼šåº“è‡ªåŠ¨å¤„ç† Offset æäº¤å’Œé‡è¯•
- âœ… **é˜²æ­¢ä¸¢å¤±**ï¼šå¤„ç†å¤±è´¥æ—¶ Offset ä¸æäº¤

**æ³¨æ„**ï¼š
- âš ï¸ **ç¡®ä¿æ‰€æœ‰æ“ä½œæˆåŠŸ**ï¼šå¿…é¡»ç¡®ä¿æ‰€æœ‰å…³é”®æ“ä½œï¼ˆæ•°æ®åº“ã€Redisã€WebSocketï¼‰éƒ½æˆåŠŸåå†è¿”å› `nil`
- âš ï¸ **å¹‚ç­‰æ€§è®¾è®¡**ï¼šç”±äºå¯èƒ½é‡å¤æ¶ˆè´¹ï¼Œéœ€è¦å®ç°å¹‚ç­‰æ€§ï¼ˆè§ [é‡å¤æ¶ˆè´¹](./5.3.é‡å¤æ¶ˆè´¹.md)ï¼‰

---

### 3. ä¸šåŠ¡é€»è¾‘å±‚ä¿éšœæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + ON CONFLICT

**å®ç°ä½ç½®**ï¼š`apps/dataflow/internal/data/kline_mysql.go`

**ä¿éšœæœºåˆ¶**ï¼š

```go
func (repo *KlineMysqlRepo) SaveKline(ctx context.Context, interval constants.KlineInterval, candleTime int64, klines []*Kline) error {
    err := repo.db.WithContext(ctx).
        Table(tableName).
        Clauses(clause.OnConflict{
            // å”¯ä¸€çº¦æŸï¼šchain_id, pair_address, candle_time
            Columns: []clause.Column{
                {Name: "chain_id"}, 
                {Name: "pair_address"}, 
                {Name: "candle_time"},
            },
            // å†²çªæ—¶æ›´æ–°ç°æœ‰è®°å½•ï¼ˆå¹‚ç­‰æ€§ï¼‰
            DoUpdates: clause.AssignmentColumns([]string{
                "open_at", "close_at", "o", "c", "h", "l", 
                "v", "t", "a", "count", "buy_count", "sell_count", "updated_at",
            }),
        }).CreateInBatches(klines, len(batch)).Error
    
    return err
}
```

**æ•°æ®åº“è¡¨ç»“æ„**ï¼š

```sql
CREATE TABLE `trade_kline_1m` (
    `id`           bigint          NOT NULL AUTO_INCREMENT,
    `chain_id`     int             NOT NULL,
    `pair_address` varchar(64)     NOT NULL,
    `candle_time`  bigint          NOT NULL,
    -- ... å…¶ä»–å­—æ®µ
    PRIMARY KEY (`id`),
    -- å”¯ä¸€çº¦æŸï¼šé˜²æ­¢é‡å¤æ’å…¥
    UNIQUE KEY `chain_id_address_index` (`chain_id`,`pair_address`,`candle_time`)
) ENGINE=InnoDB;
```

**ä¿éšœæªæ–½**ï¼š

| æªæ–½ | è¯´æ˜ | æ•ˆæœ |
|------|------|------|
| **å”¯ä¸€çº¦æŸ** | æ•°æ®åº“å±‚é¢ä¿è¯æ•°æ®å”¯ä¸€æ€§ | âœ… é˜²æ­¢é‡å¤æ•°æ® |
| **ON CONFLICT** | å†²çªæ—¶æ›´æ–°è€Œä¸æ˜¯æŠ¥é”™ | âœ… å¹‚ç­‰æ€§å¤„ç† |
| **æ‰¹é‡æ’å…¥** | ä½¿ç”¨ `CreateInBatches` æé«˜æ€§èƒ½ | âœ… æé«˜æ’å…¥é€Ÿåº¦ |

**ä¼˜ç‚¹**ï¼š
- âœ… **æ•°æ®åº“å±‚é¢ä¿è¯**ï¼šå³ä½¿é‡å¤æ¶ˆè´¹ï¼Œæ•°æ®åº“ä¹Ÿä¼šæ­£ç¡®å¤„ç†
- âœ… **å¹‚ç­‰æ€§**ï¼šé‡å¤æ’å…¥ä¼šæ›´æ–°ç°æœ‰è®°å½•ï¼Œè€Œä¸æ˜¯æŠ¥é”™
- âœ… **å¯é æ€§é«˜**ï¼šä¸ä¾èµ–åº”ç”¨å±‚é€»è¾‘

---

#### æ–¹æ¡ˆ 2ï¼šæ‰¹é‡å¤„ç†å’Œå®šæ—¶åˆ·æ–°

**å®ç°ä½ç½®**ï¼š`apps/dataflow/internal/mqs/consumers/trade_consumer.go`

**ä¿éšœæœºåˆ¶**ï¼š

```go
func (t *TradeConsumer) ticker() {
    const (
        batchSize  = 10000
        tickPeriod = time.Millisecond * 500
    )
    
    ticker := time.NewTicker(tickPeriod)
    defer ticker.Stop()
    
    batch := make([]*datakline.Kline, 0, batchSize)
    
    flush := func() {
        if len(batch) > 0 {
            t.saveKlineToDB(batch)  // æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
            batch = make([]*datakline.Kline, 0, batchSize)
        }
    }
    
    for {
        select {
        case <-t.ctx.Done():
            flush()  // é€€å‡ºå‰åˆ·æ–°
            return
        case msg := <-config.KlineProcessedCh:
            batch = append(batch, msg)
            if len(batch) >= batchSize {
                flush()  // è¾¾åˆ°æ‰¹é‡å¤§å°æ—¶åˆ·æ–°
            }
        case <-ticker.C:
            flush()  // å®šæ—¶åˆ·æ–°
        }
    }
}
```

**ä¿éšœæªæ–½**ï¼š

| æªæ–½ | è¯´æ˜ | æ•ˆæœ |
|------|------|------|
| **æ‰¹é‡å¤„ç†** | æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“ï¼Œæé«˜æ€§èƒ½ | âœ… å‡å°‘æ•°æ®åº“å‹åŠ› |
| **å®šæ—¶åˆ·æ–°** | æ¯ 500ms åˆ·æ–°ä¸€æ¬¡ï¼Œé˜²æ­¢æ•°æ®ç§¯å‹ | âœ… åŠæ—¶ä¿å­˜æ•°æ® |
| **é€€å‡ºå‰åˆ·æ–°** | Consumer é€€å‡ºå‰åˆ·æ–°æ‰€æœ‰æ•°æ® | âœ… é˜²æ­¢æ•°æ®ä¸¢å¤± |

**ä¼˜ç‚¹**ï¼š
- âœ… **æé«˜æ€§èƒ½**ï¼šæ‰¹é‡æ’å…¥å‡å°‘æ•°æ®åº“å‹åŠ›
- âœ… **åŠæ—¶ä¿å­˜**ï¼šå®šæ—¶åˆ·æ–°é˜²æ­¢æ•°æ®ç§¯å‹
- âœ… **é˜²æ­¢ä¸¢å¤±**ï¼šé€€å‡ºå‰åˆ·æ–°ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±

---

### 4. é¡¹ç›®ä¿éšœæ–¹æ¡ˆæ€»ç»“

#### Producer ç«¯ä¿éšœæ–¹æ¡ˆå¯¹æ¯”

| æœåŠ¡ | Producer ç±»å‹ | acks | é‡è¯• | é”™è¯¯å¤„ç† | é€‚ç”¨åœºæ™¯ |
|------|-------------|------|------|---------|---------|
| **Consumer** | SyncProducer | é»˜è®¤ï¼ˆ1ï¼‰ | âœ… Max=3 | âœ… ç›‘å¬é”™è¯¯å’ŒæˆåŠŸ | å…³é”®æ•°æ®ï¼ˆäº¤æ˜“æ•°æ®ï¼‰ |
| **Market** | AsyncProducer | 1 | âœ… Max=3 | âœ… ç›‘å¬é”™è¯¯ | éå…³é”®æ•°æ®ï¼ˆK çº¿æ•°æ®ï¼‰ |

**æ”¹è¿›å»ºè®®**ï¼š

1. **Consumer æœåŠ¡**ï¼š
   - âœ… å½“å‰ï¼šåŒæ­¥å‘é€ + é‡è¯• + é”™è¯¯ç›‘å¬ï¼ˆè‰¯å¥½ï¼‰
   - ğŸ’¡ å»ºè®®ï¼šè®¾ç½® `acks=all` æé«˜å¯é æ€§

2. **Market æœåŠ¡**ï¼š
   - âœ… å½“å‰ï¼šå¼‚æ­¥å‘é€ + é‡è¯• + é”™è¯¯ç›‘å¬ï¼ˆåŸºæœ¬ï¼‰
   - ğŸ’¡ å»ºè®®ï¼š
     - åœ¨é”™è¯¯å¤„ç†ä¸­å®ç°é‡è¯•é€»è¾‘
     - å¯¹äºé‡è¦æ•°æ®ï¼Œè€ƒè™‘æ”¹ä¸º `acks=all`
     - å®ç°å‘Šè­¦æœºåˆ¶

#### Consumer ç«¯ä¿éšœæ–¹æ¡ˆ

| æœåŠ¡ | Offset æäº¤æ–¹å¼ | å¤„ç†å¤±è´¥ç­–ç•¥ | å¹‚ç­‰æ€§è®¾è®¡ |
|------|---------------|------------|-----------|
| **Dataflow** | è‡ªåŠ¨æäº¤ï¼ˆå¤„ç†æˆåŠŸï¼‰ | è¿”å›é”™è¯¯ï¼Œä¸æäº¤ Offset | âœ… æ•°æ®åº“å”¯ä¸€çº¦æŸ |
| **Market** | è‡ªåŠ¨æäº¤ï¼ˆå¤„ç†æˆåŠŸï¼‰ | è¿”å›é”™è¯¯ï¼Œä¸æäº¤ Offset | âœ… æ•°æ®åº“å”¯ä¸€çº¦æŸ |
| **Smart Money** | è‡ªåŠ¨æäº¤ï¼ˆå¤„ç†æˆåŠŸï¼‰ | è¿”å›é”™è¯¯ï¼Œä¸æäº¤ Offset | âœ… ä¸šåŠ¡é€»è¾‘å¹‚ç­‰æ€§ |

**ä¼˜ç‚¹**ï¼š
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šä½¿ç”¨ go-queue/kq åº“ç»Ÿä¸€ç®¡ç† Offset
- âœ… **é˜²æ­¢ä¸¢å¤±**ï¼šå¤„ç†å¤±è´¥æ—¶ Offset ä¸æäº¤
- âœ… **å¹‚ç­‰æ€§**ï¼šæ•°æ®åº“å±‚é¢å’Œä¸šåŠ¡é€»è¾‘å±‚é¢éƒ½æœ‰å¹‚ç­‰æ€§è®¾è®¡

#### ä¸šåŠ¡é€»è¾‘å±‚ä¿éšœæ–¹æ¡ˆ

| æ–¹æ¡ˆ | å®ç°ä½ç½® | ä¿éšœæ•ˆæœ |
|------|---------|---------|
| **æ•°æ®åº“å”¯ä¸€çº¦æŸ** | K çº¿è¡¨ | âœ… é˜²æ­¢é‡å¤æ•°æ® |
| **ON CONFLICT** | K çº¿ä¿å­˜é€»è¾‘ | âœ… å¹‚ç­‰æ€§å¤„ç† |
| **æ‰¹é‡å¤„ç†** | ticker æœºåˆ¶ | âœ… æé«˜æ€§èƒ½å’Œå¯é æ€§ |
| **å®šæ—¶åˆ·æ–°** | ticker æœºåˆ¶ | âœ… åŠæ—¶ä¿å­˜æ•°æ® |

---

### 5. é¡¹ç›®ä¿éšœæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹åˆ†æ

#### ä¼˜ç‚¹

1. **å¤šå±‚ä¿éšœ**ï¼š
   - Producer ç«¯ï¼šé‡è¯•æœºåˆ¶ + é”™è¯¯ç›‘å¬
   - Consumer ç«¯ï¼šå¤„ç†æˆåŠŸæ‰æäº¤ Offset
   - ä¸šåŠ¡é€»è¾‘å±‚ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + å¹‚ç­‰æ€§è®¾è®¡

2. **ç®€å•æ˜“ç”¨**ï¼š
   - ä½¿ç”¨ go-queue/kq åº“è‡ªåŠ¨ç®¡ç† Offset
   - æ— éœ€æ‰‹åŠ¨ç®¡ç†å¤æ‚çš„ Offset æäº¤é€»è¾‘

3. **å¯é æ€§é«˜**ï¼š
   - æ•°æ®åº“å±‚é¢ä¿è¯æ•°æ®ä¸é‡å¤
   - å¤„ç†å¤±è´¥æ—¶æ¶ˆæ¯ä¼šè¢«é‡è¯•

#### ç¼ºç‚¹å’Œæ”¹è¿›å»ºè®®

1. **Producer acks é…ç½®**ï¼š
   - âš ï¸ **å½“å‰**ï¼šConsumer æœåŠ¡ä½¿ç”¨é»˜è®¤ `acks=1`ï¼ŒMarket æœåŠ¡ä½¿ç”¨ `acks=1`
   - ğŸ’¡ **å»ºè®®**ï¼šå¯¹äºå…³é”®æ•°æ®ï¼Œå»ºè®®æ”¹ä¸º `acks=all`

2. **å¼‚æ­¥å‘é€çš„é”™è¯¯å¤„ç†**ï¼š
   - âš ï¸ **å½“å‰**ï¼šMarket æœåŠ¡åªè®°å½•é”™è¯¯æ—¥å¿—
   - ğŸ’¡ **å»ºè®®**ï¼šåœ¨é”™è¯¯å¤„ç†ä¸­å®ç°é‡è¯•é€»è¾‘å’Œå‘Šè­¦æœºåˆ¶

3. **ç›‘æ§å’Œå‘Šè­¦**ï¼š
   - âš ï¸ **å½“å‰**ï¼šç¼ºå°‘ Producer é”™è¯¯ç‡å’Œ Consumer Lag çš„ç›‘æ§
   - ğŸ’¡ **å»ºè®®**ï¼šå®ç°ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

---

## ç›¸å…³æ–‡æ¡£

- [Producer ç”Ÿäº§è€…](./4.Producerç”Ÿäº§è€….md)
- [Consumer æ¶ˆè´¹è€…](./5.Consumeræ¶ˆè´¹è€….md)
- [Offset ç®¡ç†](./5.2.offsetç®¡ç†.md)
- [é‡å¤æ¶ˆè´¹](./5.3.é‡å¤æ¶ˆè´¹.md)