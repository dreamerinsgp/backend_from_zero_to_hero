
## Q3: æ¯ä¸ª Partition åŒ…å«å“ªäº›å†…å®¹ï¼Ÿ

### å®é™…æ–‡ä»¶åˆ—è¡¨

æŸ¥çœ‹ Partition ç›®å½•çš„å†…å®¹ï¼š

```bash
ls -la /tmp/kraft-combined-logs/sol-trades-0/
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
total 20
drwxrwxr-x  2 ubuntu ubuntu     4096 Feb  1 21:44 .
drwxrwxr-x 54 ubuntu ubuntu     4096 Feb  1 21:53 ..
-rw-rw-r--  1 ubuntu ubuntu 10485760 Feb  1 21:44 00000000000000000000.index
-rw-rw-r--  1 ubuntu ubuntu       72 Feb  1 21:44 00000000000000000000.log
-rw-rw-r--  1 ubuntu ubuntu 10485756 Feb  1 21:44 00000000000000000000.timeindex
-rw-rw-r--  1 ubuntu ubuntu        8 Feb  1 21:44 leader-epoch-checkpoint
-rw-rw-r--  1 ubuntu ubuntu       43 Feb  1 21:44 partition.metadata
```

### Partition ç›®å½•ç»“æ„

```
sol-trades-0/
  â”œâ”€â”€ 00000000000000000000.log              â† æ¶ˆæ¯æ•°æ®æ–‡ä»¶
  â”œâ”€â”€ 00000000000000000000.index            â† åç§»é‡ç´¢å¼•æ–‡ä»¶
  â”œâ”€â”€ 00000000000000000000.timeindex        â† æ—¶é—´ç´¢å¼•æ–‡ä»¶
  â”œâ”€â”€ leader-epoch-checkpoint               â† Leader Epoch æ£€æŸ¥ç‚¹
  â””â”€â”€ partition.metadata                    â† Partition å…ƒæ•°æ®
```

---

## Q4: è¿™äº›æ–‡ä»¶çš„å«ä¹‰ï¼Ÿ

### 1. `00000000000000000000.log` - æ¶ˆæ¯æ•°æ®æ–‡ä»¶

**ä½œç”¨**ï¼šå­˜å‚¨å®é™…çš„æ¶ˆæ¯æ•°æ®

**ç‰¹ç‚¹**ï¼š
- âœ… **è¿½åŠ å†™å…¥ï¼ˆAppend-Onlyï¼‰**ï¼šæ¶ˆæ¯åªèƒ½è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
- âœ… **ä¸å¯ä¿®æ”¹**ï¼šå·²å†™å…¥çš„æ¶ˆæ¯ä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤
- âœ… **åˆ†æ®µå­˜å‚¨**ï¼šå½“æ–‡ä»¶è¾¾åˆ° `log.segment.bytes`ï¼ˆé»˜è®¤ 1GBï¼‰æ—¶ï¼Œåˆ›å»ºæ–°çš„ segment æ–‡ä»¶
- âœ… **æ–‡ä»¶åè§„åˆ™**ï¼šæ–‡ä»¶åæ˜¯ç¬¬ä¸€ä¸ªæ¶ˆæ¯çš„ Offsetï¼ˆåç§»é‡ï¼‰ï¼Œç”¨ 20 ä½æ•°å­—è¡¨ç¤º

**æ–‡ä»¶æ ¼å¼**ï¼š
```
[æ¶ˆæ¯1é•¿åº¦(4å­—èŠ‚)][æ¶ˆæ¯1æ•°æ®]
[æ¶ˆæ¯2é•¿åº¦(4å­—èŠ‚)][æ¶ˆæ¯2æ•°æ®]
[æ¶ˆæ¯3é•¿åº¦(4å­—èŠ‚)][æ¶ˆæ¯3æ•°æ®]
...
```

**ç¤ºä¾‹**ï¼š
- `00000000000000000000.log`ï¼šä» Offset 0 å¼€å§‹çš„æ¶ˆæ¯
- `00000000000001234567.log`ï¼šä» Offset 1234567 å¼€å§‹çš„æ¶ˆæ¯ï¼ˆå½“ç¬¬ä¸€ä¸ªæ–‡ä»¶æ»¡äº†ï¼‰

---

### 2. `00000000000000000000.index` - åç§»é‡ç´¢å¼•æ–‡ä»¶

**ä½œç”¨**ï¼šæä¾›ä» Offset åˆ°æ–‡ä»¶ä½ç½®çš„å¿«é€Ÿæ˜ å°„ï¼ŒåŠ é€Ÿæ¶ˆæ¯æŸ¥æ‰¾

**å·¥ä½œåŸç†**ï¼š
- å­˜å‚¨ `<offset, position>` çš„ç¨€ç–ç´¢å¼•
- ä¸æ˜¯æ¯æ¡æ¶ˆæ¯éƒ½å»ºç«‹ç´¢å¼•ï¼Œè€Œæ˜¯**æ¯éš” N æ¡æ¶ˆæ¯**å»ºç«‹ä¸€ä¸ªç´¢å¼•ç‚¹
- æŸ¥æ‰¾æ—¶å…ˆå®šä½åˆ°æœ€è¿‘çš„ç´¢å¼•ç‚¹ï¼Œç„¶åé¡ºåºæ‰«ææ‰¾åˆ°ç›®æ ‡æ¶ˆæ¯

**ç´¢å¼•æ ¼å¼**ï¼š
```
Offset (8å­—èŠ‚) | Position (4å­—èŠ‚)
1234567        | 1024
1234568        | 2048
1234569        | 3072
...
```

**ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•ï¼Ÿ**
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…æ¯æ¬¡éƒ½è¦ä»å¤´æ‰«ææ•´ä¸ª log æ–‡ä»¶
- âš¡ **å¿«é€Ÿå®šä½**ï¼šConsumer å¯ä»¥æ ¹æ® Offset å¿«é€Ÿå®šä½åˆ°æ¶ˆæ¯ä½ç½®
- âš¡ **ç¨€ç–ç´¢å¼•**ï¼šåªè®°å½•éƒ¨åˆ†æ¶ˆæ¯çš„ä½ç½®ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´

**ç¤ºä¾‹åœºæ™¯**ï¼š
```
Consumer è¯·æ±‚ Offset = 1234567 çš„æ¶ˆæ¯ï¼š
1. æŸ¥æ‰¾ index æ–‡ä»¶ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘çš„ç´¢å¼•ç‚¹ï¼ˆå¦‚ Offset = 1234560ï¼‰
2. ä»è¯¥ç´¢å¼•ç‚¹å¯¹åº”çš„ position å¼€å§‹æ‰«æ log æ–‡ä»¶
3. é¡ºåºè¯»å–ç›´åˆ°æ‰¾åˆ° Offset = 1234567 çš„æ¶ˆæ¯
```

---

### 3. `00000000000000000000.timeindex` - æ—¶é—´ç´¢å¼•æ–‡ä»¶

**ä½œç”¨**ï¼šæä¾›ä»æ—¶é—´æˆ³åˆ° Offset çš„æ˜ å°„ï¼Œæ”¯æŒæŒ‰æ—¶é—´æŸ¥æ‰¾æ¶ˆæ¯

**å·¥ä½œåŸç†**ï¼š
- å­˜å‚¨ `<timestamp, offset>` çš„æ˜ å°„å…³ç³»
- æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢æ¶ˆæ¯ï¼ˆå¦‚"æŸ¥æ‰¾ 2024-01-01 ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯"ï¼‰

**ç´¢å¼•æ ¼å¼**ï¼š
```
Timestamp (8å­—èŠ‚) | Offset (8å­—èŠ‚)
1704067200000     | 1234567
1704067300000     | 1234568
1704067400000     | 1234569
...
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ğŸ” **æŒ‰æ—¶é—´æŸ¥è¯¢**ï¼šæŸ¥æ‰¾ç‰¹å®šæ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯
- ğŸ” **æ—¶é—´å›æº¯**ï¼šConsumer å¯ä»¥ä»æŸä¸ªæ—¶é—´ç‚¹å¼€å§‹æ¶ˆè´¹
- ğŸ” **æ—¥å¿—å®¡è®¡**ï¼šæŸ¥æ‰¾æŸä¸ªæ—¶é—´ç‚¹å‘ç”Ÿäº†ä»€ä¹ˆ

**ç¤ºä¾‹å‘½ä»¤**ï¼š
```bash
# æŸ¥æ‰¾æŒ‡å®šæ—¶é—´ä¹‹åçš„æ¶ˆæ¯
bin/kafka-console-consumer.sh \
  --topic sol-trades \
  --bootstrap-server localhost:9092 \
  --from-beginning \
  --property print.timestamp=true
```

---

### 4. `leader-epoch-checkpoint` - Leader Epoch æ£€æŸ¥ç‚¹

**ä½œç”¨**ï¼šè®°å½• Leader Epoch ä¿¡æ¯ï¼Œç”¨äºæ•°æ®ä¸€è‡´æ€§ä¿è¯å’Œå‰¯æœ¬åŒæ­¥

**Leader Epoch æ˜¯ä»€ä¹ˆï¼Ÿ**
- æ¯ä¸ª Partition çš„ Leader å˜æ›´æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ Epoch ç¼–å·
- Epoch ä» 0 å¼€å§‹é€’å¢ï¼Œæ¯æ¬¡ Leader å˜æ›´æ—¶ +1

**æ–‡ä»¶å†…å®¹ç¤ºä¾‹**ï¼š
```
0
0 1234567
```

**æ ¼å¼è¯´æ˜**ï¼š
- ç¬¬ä¸€è¡Œï¼šç‰ˆæœ¬å·ï¼ˆå½“å‰ä¸º 0ï¼‰
- åç»­è¡Œï¼š`<epoch> <start_offset>` å¯¹

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šé˜²æ­¢å‰¯æœ¬åŒæ­¥æ—¶å‡ºç°æ•°æ®ä¸ä¸€è‡´
- âœ… **Leader åˆ‡æ¢**ï¼šæ–° Leader å¯ä»¥çŸ¥é“å“ªäº›æ•°æ®æ˜¯æœ‰æ•ˆçš„
- âœ… **é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±**ï¼šç¡®ä¿å‰¯æœ¬åŒæ­¥çš„æ­£ç¡®æ€§

**å®é™…åº”ç”¨**ï¼š
```
åœºæ™¯ï¼šLeader åˆ‡æ¢
1. Broker 1 æ˜¯ Leaderï¼Œå†™å…¥æ¶ˆæ¯åˆ° Offset 1000
2. Broker 1 å®•æœºï¼ŒBroker 2 æˆä¸ºæ–° Leader
3. leader-epoch-checkpoint è®°å½•æ–°çš„ Epoch å’Œèµ·å§‹ Offset
4. æ–° Leader çŸ¥é“ä»å“ªä¸ª Offset å¼€å§‹å†™å…¥
```

---

### 5. `partition.metadata` - Partition å…ƒæ•°æ®æ–‡ä»¶

**ä½œç”¨**ï¼šå­˜å‚¨ Partition çš„å…ƒæ•°æ®ä¿¡æ¯

**åŒ…å«ä¿¡æ¯**ï¼š
- Partition çš„ç‰ˆæœ¬ä¿¡æ¯
- Segment çš„å…ƒæ•°æ®
- å…¶ä»– Partition çº§åˆ«çš„é…ç½®ä¿¡æ¯

**æ–‡ä»¶å†…å®¹ç¤ºä¾‹**ï¼š
```
version: 0
segment_count: 1
...
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- ğŸ“‹ **ç‰ˆæœ¬ç®¡ç†**ï¼šè®°å½• Partition æ ¼å¼ç‰ˆæœ¬ï¼Œæ”¯æŒå‡çº§
- ğŸ“‹ **çŠ¶æ€è·Ÿè¸ª**ï¼šè®°å½• Partition çš„çŠ¶æ€ä¿¡æ¯
- ğŸ“‹ **æ¢å¤ä¿¡æ¯**ï¼šKafka é‡å¯æ—¶ç”¨äºæ¢å¤ Partition çŠ¶æ€

---

## æ–‡ä»¶å¤§å°è¯´æ˜

### å…¸å‹æ–‡ä»¶å¤§å°

| æ–‡ä»¶ç±»å‹ | å…¸å‹å¤§å° | è¯´æ˜ |
|---------|---------|------|
| **`.log`** | å¯å˜ï¼ˆæœ€å¤§ 1GB/segmentï¼‰ | å®é™…æ¶ˆæ¯æ•°æ®ï¼Œå–å†³äºæ¶ˆæ¯æ•°é‡å’Œå¤§å° |
| **`.index`** | ~10MB | ç¨€ç–ç´¢å¼•ï¼Œå¤§å°ç›¸å¯¹å›ºå®š |
| **`.timeindex`** | ~10MB | æ—¶é—´ç´¢å¼•ï¼Œå¤§å°ç›¸å¯¹å›ºå®š |
| **`leader-epoch-checkpoint`** | å‡ å­—èŠ‚åˆ°å‡ KB | å¾ˆå°ï¼Œåªè®°å½• Epoch ä¿¡æ¯ |
| **`partition.metadata`** | å‡ åå­—èŠ‚ | å¾ˆå°ï¼Œåªè®°å½•å…ƒæ•°æ® |

### æ–‡ä»¶å¤§å°å…³ç³»

```
.log æ–‡ä»¶å¤§å° >> .index æ–‡ä»¶å¤§å° â‰ˆ .timeindex æ–‡ä»¶å¤§å°
```

**åŸå› **ï¼š
- `.log` æ–‡ä»¶å­˜å‚¨å®é™…æ¶ˆæ¯å†…å®¹ï¼Œå¯èƒ½å¾ˆå¤§
- `.index` å’Œ `.timeindex` æ˜¯ç¨€ç–ç´¢å¼•ï¼Œåªè®°å½•éƒ¨åˆ†æ¶ˆæ¯çš„ä¿¡æ¯

---

## Segment æ–‡ä»¶å‘½åè§„åˆ™

### æ–‡ä»¶åæ ¼å¼

æ–‡ä»¶åæ˜¯ **20 ä½æ•°å­—**ï¼Œè¡¨ç¤ºè¯¥ Segment ä¸­**ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ Offset**ï¼š

```
00000000000000000000.log  â† Offset 0 å¼€å§‹
00000000000001234567.log  â† Offset 1234567 å¼€å§‹
00000000000002469135.log  â† Offset 2469135 å¼€å§‹
```

### ä¸ºä»€ä¹ˆç”¨ Offset ä½œä¸ºæ–‡ä»¶åï¼Ÿ

1. **å¿«é€Ÿå®šä½**ï¼šæ ¹æ® Offset å¯ä»¥ç›´æ¥æ‰¾åˆ°å¯¹åº”çš„ Segment æ–‡ä»¶
2. **å”¯ä¸€æ ‡è¯†**ï¼šOffset åœ¨ Partition å†…æ˜¯å”¯ä¸€çš„
3. **é¡ºåºæ€§**ï¼šæ–‡ä»¶åè‡ªç„¶æ’åºï¼Œä¾¿äºç®¡ç†

### Segment æ»šåŠ¨æ¡ä»¶

å½“æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„ Segmentï¼š

1. **å¤§å°é™åˆ¶**ï¼šå½“å‰ Segment è¾¾åˆ° `log.segment.bytes`ï¼ˆé»˜è®¤ 1GBï¼‰
2. **æ—¶é—´é™åˆ¶**ï¼šå½“å‰ Segment åˆ›å»ºæ—¶é—´è¶…è¿‡ `log.roll.ms`ï¼ˆé»˜è®¤ä¸é™åˆ¶ï¼‰
3. **ç´¢å¼•é™åˆ¶**ï¼šç´¢å¼•æ–‡ä»¶è¾¾åˆ°ä¸€å®šå¤§å°

---

## å®é™…æŸ¥çœ‹ç¤ºä¾‹

### æŸ¥çœ‹ Partition æ–‡ä»¶è¯¦æƒ…

```bash
# 1. æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
ls -lh /tmp/kraft-combined-logs/sol-trades-0/

# 2. æŸ¥çœ‹ log æ–‡ä»¶å¤§å°ï¼ˆä¼°ç®—æ¶ˆæ¯æ•°é‡ï¼‰
ls -lh /tmp/kraft-combined-logs/sol-trades-0/*.log

# 3. æŸ¥çœ‹ç´¢å¼•æ–‡ä»¶å¤§å°
ls -lh /tmp/kraft-combined-logs/sol-trades-0/*.index

# 4. æŸ¥çœ‹ Partition æ€»å¤§å°
du -sh /tmp/kraft-combined-logs/sol-trades-0/
```

### æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰

```bash
# æŸ¥çœ‹ leader-epoch-checkpointï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
cat /tmp/kraft-combined-logs/sol-trades-0/leader-epoch-checkpoint

# æŸ¥çœ‹ partition.metadataï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
cat /tmp/kraft-combined-logs/sol-trades-0/partition.metadata

# âš ï¸ æ³¨æ„ï¼šä¸è¦ç›´æ¥æŸ¥çœ‹ .logã€.indexã€.timeindex æ–‡ä»¶
# è¿™äº›æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ Kafka å·¥å…·æŸ¥çœ‹
```

---

## æ€»ç»“

### Partition ç›®å½•å‘½å

- **æ ¼å¼**ï¼š`<topic-name>-<partition-id>`
- **ç¤ºä¾‹**ï¼š`sol-trades-0` è¡¨ç¤º `sol-trades` Topic çš„ Partition 0
- **Partition ID**ï¼šä» 0 å¼€å§‹ç¼–å·

### Partition æ–‡ä»¶ç»„æˆ

| æ–‡ä»¶ | ä½œç”¨ | é‡è¦æ€§ |
|------|------|--------|
| **`.log`** | å­˜å‚¨æ¶ˆæ¯æ•°æ® | â­â­â­â­â­ æ ¸å¿ƒæ–‡ä»¶ |
| **`.index`** | Offset ç´¢å¼• | â­â­â­â­ æ€§èƒ½ä¼˜åŒ– |
| **`.timeindex`** | æ—¶é—´ç´¢å¼• | â­â­â­ æ—¶é—´æŸ¥è¯¢ |
| **`leader-epoch-checkpoint`** | Leader Epoch ä¿¡æ¯ | â­â­â­â­ æ•°æ®ä¸€è‡´æ€§ |
| **`partition.metadata`** | Partition å…ƒæ•°æ® | â­â­ å…ƒæ•°æ®ç®¡ç† |

### å…³é”®è¦ç‚¹

1. âœ… **`.log` æ–‡ä»¶**ï¼šå­˜å‚¨å®é™…æ¶ˆæ¯ï¼Œæ˜¯æ ¸å¿ƒæ•°æ®æ–‡ä»¶
2. âœ… **ç´¢å¼•æ–‡ä»¶**ï¼šæä¾›å¿«é€ŸæŸ¥æ‰¾èƒ½åŠ›ï¼Œæå‡æ€§èƒ½
3. âœ… **Segment æœºåˆ¶**ï¼šæ–‡ä»¶åˆ†æ®µå­˜å‚¨ï¼Œä¾¿äºç®¡ç†å’Œæ¸…ç†
4. âœ… **æ–‡ä»¶åè§„åˆ™**ï¼šä½¿ç”¨ Offset ä½œä¸ºæ–‡ä»¶åï¼Œä¾¿äºå®šä½
5. âœ… **ä¸å¯ä¿®æ”¹**ï¼šPartition æ–‡ä»¶æ˜¯è¿½åŠ å†™å…¥ï¼Œå·²å†™å…¥çš„æ¶ˆæ¯ä¸å¯ä¿®æ”¹

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- Partition è¯¦ç»†è¯´æ˜ï¼š`3.Partitionåˆ†åŒº.md`
- Topic è¯´æ˜ï¼š`2.Topicä¸»é¢˜.md`
- Offset è¯´æ˜ï¼š`7.Offsetåç§»é‡.md`
