# Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰

---

## Q1: ä»€ä¹ˆæ˜¯ Consumerï¼Ÿ

**Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰** æ˜¯ Kafka ä¸­è´Ÿè´£ä» Topic è¯»å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚

### æ ¸å¿ƒæ¦‚å¿µ

- **ä½œç”¨**ï¼šä» Kafka é›†ç¾¤çš„æŒ‡å®š Topic æ¶ˆè´¹æ¶ˆæ¯
- **ç‰¹ç‚¹**ï¼š
  - æ”¯æŒ Consumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰å®ç°è´Ÿè½½å‡è¡¡
  - è‡ªåŠ¨ç®¡ç† Offsetï¼ˆæ¶ˆè´¹è¿›åº¦ï¼‰
  - æ”¯æŒä»æŒ‡å®š Offset å¼€å§‹æ¶ˆè´¹
  - æ”¯æŒè‡ªåŠ¨æäº¤æˆ–æ‰‹åŠ¨æäº¤ Offset

### Consumer çš„å·¥ä½œæµç¨‹

```
Consumer â†’ è¿æ¥åˆ° Broker â†’ åŠ å…¥ Consumer Group â†’ åˆ†é… Partition â†’ æ¶ˆè´¹æ¶ˆæ¯ â†’ æäº¤ Offset
```

### Consumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰

- **ä½œç”¨**ï¼šå¤šä¸ª Consumer å®ä¾‹å¯ä»¥ç»„æˆä¸€ä¸ª Consumer Groupï¼Œå®ç°è´Ÿè½½å‡è¡¡
- **å·¥ä½œåŸç†**ï¼š
  - åŒä¸€ä¸ª Consumer Group ä¸­çš„ Consumer ä¼š**å…±äº«**æ¶ˆè´¹åŒä¸€ä¸ª Topic
  - Kafka ä¼šå°† Topic çš„ Partition **åˆ†é…**ç»™ä¸åŒçš„ Consumer
  - æ¯ä¸ª Partition åªä¼šè¢« Consumer Group ä¸­çš„**ä¸€ä¸ª** Consumer æ¶ˆè´¹

**ç¤ºä¾‹**ï¼š
```
Topic: sol-trades (3 ä¸ª Partition)
Consumer Group: data-flow-group (2 ä¸ª Consumer)

åˆ†é…ç»“æœï¼š
- Consumer 1 â†’ Partition 0, Partition 1
- Consumer 2 â†’ Partition 2
```

---

## Q2: é¡¹ç›®ä¸­ Consumer çš„å®ç°ä½ç½®åœ¨å“ªé‡Œï¼Ÿ

é¡¹ç›®ä¸­ Consumer çš„å®ç°ä¸»è¦ä½äºä»¥ä¸‹ä½ç½®ï¼š

### 1. **Dataflow æœåŠ¡ - äº¤æ˜“æ•°æ®æ¶ˆè´¹å’Œ K çº¿ç”Ÿæˆ**

**ä½ç½®**ï¼š`apps/dataflow/internal/mqs/consumers/trade_consumer.go`

**Consumer Group**ï¼š`data-flow-default-group-1888`

**æ¶ˆè´¹çš„ Topic**ï¼š
- `sol-trades`ï¼ˆSolana é“¾ï¼‰
- `bsc-trades`ï¼ˆBSC é“¾ï¼‰
- `evm-trades-v4`ï¼ˆEVM é“¾ï¼ŒåŒ…æ‹¬ ETHã€Base ç­‰ï¼‰

**å…³é”®ä»£ç **ï¼š

```go
type TradeConsumer struct {
    ctx            context.Context
    svcCtx         *svc.ServiceContext
    klineMysqlRepo *data.KlineMysqlRepo
    workerPool     *ants.Pool  // å·¥ä½œæ± ï¼ˆ10 ä¸ª goroutineï¼‰
    chainId        constants.ChainId
}

func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. ååºåˆ—åŒ–äº¤æ˜“æ•°æ®
    var tradeMsg []*model.TradeWithPair
    json.Unmarshal(key.Value, &tradeMsg)
    
    // 2. ç”Ÿæˆ K çº¿æ•°æ®
    klineMap := logic.GenerateKlinesWithTradesFromTrades(ctx, tradeMsg)
    
    // 3. å¹¶å‘å¤„ç†æ¯ä¸ªäº¤æ˜“å¯¹çš„ K çº¿
    for _, klineWithTrade := range klineMap {
        t.workerPool.Submit(func() {
            // 3.1 å‘é€åˆ° Redis
            for i := 0; i < len(k.Klines); i++ {
                klineData := cache.KlineRedisCache.NewPush(ctx, k.Klines[i])
                config.KlineProcessedCh <- klineData
            }
            
            // 3.2 å‘é€åˆ° WebSocketï¼ˆå¼‚æ­¥ï¼‰
            go func() {
                t.SendKlinesToWsServer(ctx, k)
            }()
        })
    }
    
    return nil
}

// åå°æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
func (t *TradeConsumer) ticker() {
    const (
        batchSize  = 10000  // æ‰¹é‡å¤§å°
        tickPeriod = time.Millisecond * 500  // åˆ·æ–°å‘¨æœŸ
    )
    
    ticker := time.NewTicker(tickPeriod)
    batch := make([]*datakline.Kline, 0, batchSize)
    
    for {
        select {
        case msg := <-config.KlineProcessedCh:
            batch = append(batch, msg)
            if len(batch) >= batchSize {
                t.saveKlineToDB(batch)  // æ‰¹é‡ä¿å­˜
                batch = batch[:0]
            }
        case <-ticker.C:
            t.saveKlineToDB(batch)  // å®šæ—¶ä¿å­˜
            batch = batch[:0]
        }
    }
}
```

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ğŸ“Š æ¶ˆè´¹äº¤æ˜“æ•°æ®ï¼Œç”Ÿæˆ K çº¿æ•°æ®
- ğŸ’¾ ä¿å­˜ K çº¿æ•°æ®åˆ° Redis å’Œ MySQL
- ğŸ“¡ å®æ—¶æ¨é€ K çº¿æ•°æ®åˆ° WebSocket

---

### 2. **Market æœåŠ¡ - K çº¿æ•°æ®ç®¡ç†**

**ä½ç½®**ï¼š`apps/market/internal/mqs/consumers/trade_consumer.go`

**Consumer Group**ï¼š`data-flow-default-group-1888`ï¼ˆä¸ Dataflow ç›¸åŒï¼‰

**æ¶ˆè´¹çš„ Topic**ï¼š`sol-trades`

**å…³é”®ä»£ç **ï¼š

```go
type TradeConsumer struct {
    ctx            context.Context
    svcCtx         *svc.ServiceContext
    klineMysqlRepo *data.KlineMysqlRepo
    workerPool     *ants.Pool  // å·¥ä½œæ± ï¼ˆ30 ä¸ª goroutineï¼‰
}

func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. ååºåˆ—åŒ–äº¤æ˜“æ•°æ®
    var tradeMsg []*model.TradeWithPair
    json.Unmarshal(key.Value, &tradeMsg)
    
    // 2. ç”Ÿæˆ K çº¿æ•°æ®
    klineMap := logic.GenerateKlinesWithTradesFromTrades(ctx, tradeMsg)
    
    // 3. ä¿å­˜åˆ° Redis
    for _, klineWithTrade := range klineMap {
        for i := 0; i < len(k.Klines); i++ {
            k.Klines[i] = cache.KlineRedisCache.NewPush(ctx, k.Klines[i])
        }
    }
    
    return nil
}
```

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ğŸ“Š æ¶ˆè´¹äº¤æ˜“æ•°æ®ï¼Œç”Ÿæˆ K çº¿æ•°æ®
- ğŸ’¾ ä¿å­˜ K çº¿æ•°æ®åˆ° Redisï¼ˆæ•°æ®åº“ä¿å­˜å·²æ³¨é‡Šï¼‰

---

### 3. **Smart Money æœåŠ¡ - æ™ºèƒ½èµ„é‡‘è¿½è¸ª**

**ä½ç½®**ï¼š`apps/smart_money/internal/mqs/consumers/smart_money_consumer.go`

**Consumer Group**ï¼š`data-kline-group-api`ï¼ˆç‹¬ç«‹ï¼‰

**æ¶ˆè´¹çš„ Topic**ï¼š`sol-trades`

**å…³é”®ä»£ç **ï¼š

```go
type SmartMoneyConsumer struct {
    ctx    context.Context
    svcCtx *svc.ServiceContext
    filter map[string]*SmartMoneyAddressBloomFilter  // å¸ƒéš†è¿‡æ»¤å™¨
}

func (c *SmartMoneyConsumer) Consume(ctx context.Context, key, val string) error {
    // 1. ååºåˆ—åŒ–äº¤æ˜“æ•°æ®
    var tradeMsg []*model.TradeWithPair
    json.Unmarshal([]byte(val), &tradeMsg)
    
    // 2. å¤„ç†æ¯æ¡äº¤æ˜“
    return c.handleTradeMsg(tradeMsg)
}

func (c *SmartMoneyConsumer) handleTradeMsg(trades []*model.TradeWithPair) error {
    for _, trade := range trades {
        // 2.1 æ£€æŸ¥æ˜¯å¦ä¸ºæ™ºèƒ½èµ„é‡‘åœ°å€ï¼ˆä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼‰
        ok, _ := c.filter[trade.ChainId].ContainsAddress(trade.Maker)
        if !ok {
            continue  // ä¸æ˜¯æ™ºèƒ½èµ„é‡‘åœ°å€ï¼Œè·³è¿‡
        }
        
        // 2.2 è®°å½•æ™ºèƒ½èµ„é‡‘äº¤æ˜“æ—¥å¿—
        c.svcCtx.SmartMoneyLogModel.InsertSharding(...)
        
        // 2.3 å¤„ç†äº¤æ˜“å¹¶å‘é€é€šçŸ¥
        c.doHandleTradeMsg(trade)
    }
    
    return nil
}
```

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ğŸ” è¯†åˆ«æ™ºèƒ½èµ„é‡‘åœ°å€ï¼ˆä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼‰
- ğŸ“ è®°å½•æ™ºèƒ½èµ„é‡‘äº¤æ˜“æ—¥å¿—
- ğŸ”” å‘é€é€šçŸ¥ç»™å…³æ³¨è¯¥åœ°å€çš„ç”¨æˆ·

---

### 4. **Consumer å¯åŠ¨æ–¹å¼**

**ä½¿ç”¨ go-queue/kq åº“å°è£…**ï¼š

```go
// ä½ç½®ï¼šapps/dataflow/internal/mqs/mqs.go
func TradeConsumers(c config.Config, ctx context.Context, svcContext *svc.ServiceContext) []service.Service {
    var res []service.Service
    
    // ä¸ºæ¯ä¸ªé“¾åˆ›å»º Consumer
    for _, chainId := range constants.ChainIds {
        if chainId == constants.Sol {
            c.KqSolConf.MinBytes = 0  // å‡å°‘å»¶è¿Ÿ
            res = append(res, kq.MustNewQueue(
                c.KqSolConf,                    // é…ç½®
                consumers.NewTradeConsumer(ctx, svcContext, chainId),  // Handler
            ))
        }
        // ... å…¶ä»–é“¾
    }
    
    return res
}
```

**æœåŠ¡å¯åŠ¨**ï¼š

```go
// ä½ç½®ï¼šapps/dataflow/dataflow.go
serviceGroup := service.NewServiceGroup()
for _, mq := range mqs.TradeConsumers(c, context.Background(), ctx) {
    serviceGroup.Add(mq)  // æ·»åŠ åˆ°æœåŠ¡ç»„
}
serviceGroup.Start()  // å¯åŠ¨æ‰€æœ‰ Consumer
```

---

## Q3: å¦‚ä½•æ¶ˆè´¹ Kafka æ¶ˆæ¯ï¼Ÿ

### æ–¹å¼ 1ï¼šä½¿ç”¨ go-queue/kq åº“ï¼ˆé¡¹ç›®ä¸­ä½¿ç”¨çš„æ–¹å¼ï¼‰

é¡¹ç›®ä½¿ç”¨ `go-queue/kq` åº“å°è£… Kafka Consumerï¼Œç®€åŒ–äº†ä½¿ç”¨æ–¹å¼ã€‚

#### **æ­¥éª¤ 1ï¼šå®ç° Consumer Handler æ¥å£**

```go
// æ–¹å¼ 1ï¼šä½¿ç”¨ kafka.Messageï¼ˆdataflow/market ä½¿ç”¨ï¼‰
type TradeConsumer struct {
    // ... å­—æ®µ
}

func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. ååºåˆ—åŒ–æ¶ˆæ¯
    var tradeMsg []*model.TradeWithPair
    if err := json.Unmarshal(key.Value, &tradeMsg); err != nil {
        return err
    }
    
    // 2. å¤„ç†æ¶ˆæ¯
    // ...
    
    return nil
}

// æ–¹å¼ 2ï¼šä½¿ç”¨ key, val stringï¼ˆsmart_money ä½¿ç”¨ï¼‰
type SmartMoneyConsumer struct {
    // ... å­—æ®µ
}

func (c *SmartMoneyConsumer) Consume(ctx context.Context, key, val string) error {
    // 1. ååºåˆ—åŒ–æ¶ˆæ¯
    var tradeMsg []*model.TradeWithPair
    if err := json.Unmarshal([]byte(val), &tradeMsg); err != nil {
        return err
    }
    
    // 2. å¤„ç†æ¶ˆæ¯
    // ...
    
    return nil
}
```

#### **æ­¥éª¤ 2ï¼šé…ç½® Consumer**

```yaml
# etc/dataflow.yaml
KqSol:
  Name: data-trade.rpc
  Brokers:
    - localhost:9092
  Group: data-flow-default-group-1888  # Consumer Group
  Topic: sol-trades                    # Topic åç§°
  Offset: last                         # æ¶ˆè´¹ä½ç½®ï¼šlastï¼ˆæœ€æ–°ï¼‰æˆ– firstï¼ˆæœ€æ—©ï¼‰
  Consumers: 1                         # Consumer å®ä¾‹æ•°é‡
  Processors: 1                        # å¤„ç†å™¨æ•°é‡
  Username: "username"                 # SASL ç”¨æˆ·å
  Password: "password"                 # SASL å¯†ç 
```

#### **æ­¥éª¤ 3ï¼šåˆ›å»ºå¹¶å¯åŠ¨ Consumer**

```go
package main

import (
    "context"
    "github.com/chengfield/go-queue/kq"
    "github.com/dexs-k/dexs-backend/apps/dataflow/internal/config"
    "github.com/dexs-k/dexs-backend/apps/dataflow/internal/mqs/consumers"
    "github.com/zeromicro/go-zero/core/service"
)

func main() {
    var c config.Config
    conf.MustLoad("etc/dataflow.yaml", &c)
    
    ctx := svc.NewServiceContext(c)
    
    // åˆ›å»º Consumer æœåŠ¡
    serviceGroup := service.NewServiceGroup()
    for _, mq := range mqs.TradeConsumers(c, context.Background(), ctx) {
        serviceGroup.Add(mq)
    }
    
    // å¯åŠ¨ Consumer
    serviceGroup.Start()
}
```

---

### æ–¹å¼ 2ï¼šç›´æ¥ä½¿ç”¨ kafka-go åº“

å¦‚æœä¸æƒ³ä½¿ç”¨å°è£…åº“ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `kafka-go` åº“ã€‚

#### **ç¤ºä¾‹ï¼šä½¿ç”¨ kafka-go Reader**

```go
package main

import (
    "context"
    "github.com/segmentio/kafka-go"
    "github.com/zeromicro/go-zero/core/logx"
)

func consumeWithKafkaGo() {
    // 1. åˆ›å»º Reader
    reader := kafka.NewReader(kafka.ReaderConfig{
        Brokers:  []string{"localhost:9092"},
        Topic:    "sol-trades",
        GroupID:  "my-consumer-group",
        MinBytes: 10e3,  // 10KB
        MaxBytes: 10e6,  // 10MB
    })
    defer reader.Close()
    
    // 2. æ¶ˆè´¹æ¶ˆæ¯
    for {
        message, err := reader.ReadMessage(context.Background())
        if err != nil {
            logx.Errorf("Read message error: %v", err)
            break
        }
        
        // 3. å¤„ç†æ¶ˆæ¯
        logx.Infof("Message at topic/partition/offset %v/%v/%v: %s = %s\n",
            message.Topic, message.Partition, message.Offset,
            string(message.Key), string(message.Value))
        
        // 4. æäº¤ Offsetï¼ˆè‡ªåŠ¨æäº¤ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æäº¤ï¼‰
    }
}
```

---

### æ–¹å¼ 3ï¼šä½¿ç”¨ sarama åº“ï¼ˆConsumer Groupï¼‰

```go
package main

import (
    "context"
    "github.com/IBM/sarama"
    "github.com/zeromicro/go-zero/core/logx"
)

type ConsumerGroupHandler struct{}

func (h *ConsumerGroupHandler) Setup(sarama.ConsumerGroupSession) error {
    return nil
}

func (h *ConsumerGroupHandler) Cleanup(sarama.ConsumerGroupSession) error {
    return nil
}

func (h *ConsumerGroupHandler) ConsumeClaim(
    session sarama.ConsumerGroupSession,
    claim sarama.ConsumerGroupClaim,
) error {
    for {
        select {
        case message := <-claim.Messages():
            if message == nil {
                return nil
            }
            
            // å¤„ç†æ¶ˆæ¯
            logx.Infof("Message: %s = %s", string(message.Key), string(message.Value))
            
            // æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
            session.MarkMessage(message, "")
            
        case <-session.Context().Done():
            return nil
        }
    }
}

func consumeWithSarama() {
    config := sarama.NewConfig()
    config.Consumer.Group.Rebalance.Strategy = sarama.BalanceStrategyRoundRobin
    config.Consumer.Offsets.Initial = sarama.OffsetNewest
    
    // åˆ›å»º Consumer Group
    consumer, err := sarama.NewConsumerGroup(
        []string{"localhost:9092"},
        "my-consumer-group",
        config,
    )
    if err != nil {
        logx.Errorf("Error creating consumer group: %v", err)
        return
    }
    defer consumer.Close()
    
    // å¯åŠ¨æ¶ˆè´¹
    handler := &ConsumerGroupHandler{}
    for {
        err := consumer.Consume(context.Background(), []string{"sol-trades"}, handler)
        if err != nil {
            logx.Errorf("Error from consumer: %v", err)
            break
        }
    }
}
```

---

## Consumer é…ç½®è¯¦è§£

### 1. **Consumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰**

```yaml
Group: data-flow-default-group-1888
```

**ä½œç”¨**ï¼š
- å¤šä¸ª Consumer å®ä¾‹å¯ä»¥ç»„æˆä¸€ä¸ª Consumer Group
- å®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™

**å·¥ä½œåŸç†**ï¼š
- åŒä¸€ä¸ª Consumer Group ä¸­çš„ Consumer ä¼š**å…±äº«**æ¶ˆè´¹åŒä¸€ä¸ª Topic
- Kafka ä¼šå°† Topic çš„ Partition **åˆ†é…**ç»™ä¸åŒçš„ Consumer
- æ¯ä¸ª Partition åªä¼šè¢« Consumer Group ä¸­çš„**ä¸€ä¸ª** Consumer æ¶ˆè´¹

---

### 2. **Offsetï¼ˆæ¶ˆè´¹ä½ç½®ï¼‰**

```yaml
Offset: last  # æˆ– first
```

**é€‰é¡¹**ï¼š
- `last`ï¼šä»æœ€æ–°çš„æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼ˆé»˜è®¤ï¼‰
- `first`ï¼šä»æœ€æ—©çš„æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹

**Offset ç®¡ç†**ï¼š
- **è‡ªåŠ¨æäº¤**ï¼šConsumer è‡ªåŠ¨æäº¤ Offsetï¼ˆé»˜è®¤ï¼‰
- **æ‰‹åŠ¨æäº¤**ï¼šå¯ä»¥æ‰‹åŠ¨æäº¤ Offsetï¼Œç¡®ä¿æ¶ˆæ¯å¤„ç†å®Œæˆåå†æäº¤

---

### 3. **Consumer å®ä¾‹æ•°é‡**

```yaml
Consumers: 1
```

**è¯´æ˜**ï¼š
- ä¸€ä¸ª Consumer å®ä¾‹å¯ä»¥æ¶ˆè´¹å¤šä¸ª Partition
- å¢åŠ  Consumer å®ä¾‹å¯ä»¥æé«˜æ¶ˆè´¹é€Ÿåº¦
- Consumer å®ä¾‹æ•°é‡ä¸èƒ½è¶…è¿‡ Partition æ•°é‡

**ç¤ºä¾‹**ï¼š
```
Topic: sol-trades (3 ä¸ª Partition)
Consumers: 2

åˆ†é…ç»“æœï¼š
- Consumer 1 â†’ Partition 0, Partition 1
- Consumer 2 â†’ Partition 2
```

---

### 4. **Processor æ•°é‡**

```yaml
Processors: 1
```

**è¯´æ˜**ï¼š
- Processor æ˜¯å¤„ç†æ¶ˆæ¯çš„å¹¶å‘æ•°
- å¢åŠ  Processor å¯ä»¥æé«˜æ¶ˆæ¯å¤„ç†é€Ÿåº¦

---

### 5. **MinBytesï¼ˆæœ€å°å­—èŠ‚æ•°ï¼‰**

```go
c.KqSolConf.MinBytes = 0  // å‡å°‘å»¶è¿Ÿ
```

**è¯´æ˜**ï¼š
- Consumer ç­‰å¾…ç´¯ç§¯åˆ°æŒ‡å®šå­—èŠ‚æ•°åå†æ‹‰å–æ¶ˆæ¯
- `0` è¡¨ç¤ºç«‹å³æ‹‰å–ï¼Œå‡å°‘å»¶è¿Ÿ
- è¾ƒå¤§çš„å€¼å¯ä»¥æé«˜ååé‡ï¼Œä½†ä¼šå¢åŠ å»¶è¿Ÿ

---

## é¡¹ç›®ä¸­çš„ Consumer å®ç°æ€»ç»“

### Consumer å®ç°ä½ç½®

| æœåŠ¡ | Consumer ä½ç½® | Consumer Group | Topic | ä¸»è¦åŠŸèƒ½ |
|------|--------------|---------------|-------|---------|
| **Dataflow** | `apps/dataflow/internal/mqs/consumers/trade_consumer.go` | `data-flow-default-group-1888` | `sol-trades`, `bsc-trades`, `evm-trades-v4` | K çº¿ç”Ÿæˆã€æ•°æ®å­˜å‚¨ã€WebSocket æ¨é€ |
| **Market** | `apps/market/internal/mqs/consumers/trade_consumer.go` | `data-flow-default-group-1888` | `sol-trades` | K çº¿ç”Ÿæˆã€Redis ç¼“å­˜ |
| **Smart Money** | `apps/smart_money/internal/mqs/consumers/smart_money_consumer.go` | `data-kline-group-api` | `sol-trades` | æ™ºèƒ½èµ„é‡‘è¿½è¸ªã€é€šçŸ¥ |

### Consumer æ¥å£å®ç°

**Dataflow/Market æœåŠ¡**ï¼š
```go
func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // å¤„ç†æ¶ˆæ¯
    return nil
}
```

**Smart Money æœåŠ¡**ï¼š
```go
func (c *SmartMoneyConsumer) Consume(ctx context.Context, key, val string) error {
    // å¤„ç†æ¶ˆæ¯
    return nil
}
```

---

## Consumer æœ€ä½³å®è·µ

### 1. **é”™è¯¯å¤„ç†**

```go
func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // 1. ååºåˆ—åŒ–
    var tradeMsg []*model.TradeWithPair
    if err := json.Unmarshal(key.Value, &tradeMsg); err != nil {
        logc.Errorf(ctx, "Failed to unmarshal: %v", err)
        return err  // è¿”å›é”™è¯¯ï¼Œæ¶ˆæ¯ä¼šè¢«é‡è¯•
    }
    
    // 2. å¤„ç†æ¶ˆæ¯
    if err := t.processMessage(ctx, tradeMsg); err != nil {
        logc.Errorf(ctx, "Failed to process: %v", err)
        return err  // è¿”å›é”™è¯¯ï¼Œæ¶ˆæ¯ä¼šè¢«é‡è¯•
    }
    
    return nil  // æˆåŠŸï¼ŒOffset ä¼šè¢«æäº¤
}
```

---

### 2. **å¹¶å‘å¤„ç†**

```go
type TradeConsumer struct {
    workerPool *ants.Pool  // å·¥ä½œæ± 
}

func (t *TradeConsumer) Consume(ctx context.Context, key kafka.Message) error {
    // ä½¿ç”¨å·¥ä½œæ± å¹¶å‘å¤„ç†
    for _, item := range items {
        t.workerPool.Submit(func() {
            // å¤„ç†å•ä¸ª item
            processItem(item)
        })
    }
    
    return nil
}
```

---

### 3. **æ‰¹é‡å¤„ç†**

```go
func (t *TradeConsumer) ticker() {
    const batchSize = 10000
    ticker := time.NewTicker(500 * time.Millisecond)
    batch := make([]*Kline, 0, batchSize)
    
    for {
        select {
        case msg := <-ch:
            batch = append(batch, msg)
            if len(batch) >= batchSize {
                t.saveBatch(batch)  // æ‰¹é‡ä¿å­˜
                batch = batch[:0]
            }
        case <-ticker.C:
            t.saveBatch(batch)  // å®šæ—¶ä¿å­˜
            batch = batch[:0]
        }
    }
}
```

---

## ç›¸å…³æ–‡æ¡£

- [Producer ç”Ÿäº§è€…](./4.Producerç”Ÿäº§è€….md)
- [Topic ä¸»é¢˜](./2.Topicä¸»é¢˜.md)
- [Partition åˆ†åŒº](./3.Partitionåˆ†åŒº.md)
