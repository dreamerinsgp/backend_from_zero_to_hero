# Kafka ç¯å¢ƒæ­å»ºæŒ‡å—

## ğŸ“š å­¦ä¹ èµ„æº

1. Kafka åŸºç¡€æ¦‚è¿°ï¼šhttps://meeting.tencent.com/crm/23DvEGLO45
2. Kafka åŸºç¡€æ“ä½œï¼šhttps://meeting.tencent.com/crm/lJLOVWboc8

---

## ğŸš€ å®‰è£…æ–¹å¼é€‰æ‹©

### æ–¹å¼ä¸€ï¼šæœ¬åœ°å®‰è£…ï¼ˆé€‚åˆå­¦ä¹ å’Œå¼€å‘ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œä¾¿äºè°ƒè¯•
- âœ… æ›´å¥½çš„æ€§èƒ½ï¼ˆæ— å®¹å™¨å¼€é”€ï¼‰
- âœ… å®Œå…¨æ§åˆ¶é…ç½®

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦å®‰è£… Java
- âš ï¸ éœ€è¦æ‰‹åŠ¨ç®¡ç†è¿›ç¨‹

### æ–¹å¼äºŒï¼šDocker å®‰è£…ï¼ˆæ¨èï¼Œå¿«é€Ÿä¸Šæ‰‹ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… å¿«é€Ÿå¯åŠ¨ï¼Œæ— éœ€å®‰è£… Java
- âœ… ç¯å¢ƒéš”ç¦»ï¼Œæ˜“äºæ¸…ç†
- âœ… è·¨å¹³å°ä¸€è‡´

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ Docker ç¯å¢ƒ

---

## ğŸ“¥ æ–¹å¼ä¸€ï¼šæœ¬åœ°å®‰è£… Kafka

### å‰ç½®è¦æ±‚

**Java 17+**ï¼ˆKafka 3.0+ éœ€è¦ Java 17ï¼ŒKafka 2.x éœ€è¦ Java 11ï¼‰

#### 1. æ£€æŸ¥ Java ç‰ˆæœ¬

```bash
java -version
```

å¦‚æœæœªå®‰è£…æˆ–ç‰ˆæœ¬è¿‡ä½ï¼Œè¯·å…ˆå®‰è£… Javaï¼š

**Ubuntu/Debian**ï¼š
```bash
# å®‰è£… OpenJDK 17
sudo apt update
sudo apt install openjdk-17-jdk -y

# éªŒè¯å®‰è£…
java -version
```

**macOS**ï¼š
```bash
# ä½¿ç”¨ Homebrew
brew install openjdk@17

# è®¾ç½®ç¯å¢ƒå˜é‡
export JAVA_HOME=$(/usr/libexec/java_home -v 17)
```

**CentOS/RHEL**ï¼š
```bash
# å®‰è£… OpenJDK 17
sudo yum install java-17-openjdk-devel -y

# éªŒè¯å®‰è£…
java -version
```

---

### 2. ä¸‹è½½ Kafka

#### æ–¹æ³• Aï¼šä½¿ç”¨ wget/curl ä¸‹è½½ï¼ˆæ¨èï¼‰

```bash
# åˆ›å»ºå®‰è£…ç›®å½•
mkdir -p ~/kafka
cd ~/kafka

# ä¸‹è½½ Kafkaï¼ˆæœ€æ–°ç‰ˆæœ¬ 3.7.0ï¼ŒScala 2.13ï¼‰
wget https://downloads.apache.org/kafka/3.7.0/kafka_2.13-3.7.0.tgz

# æˆ–è€…ä½¿ç”¨ curl
# curl -O https://downloads.apache.org/kafka/3.7.0/kafka_2.13-3.7.0.tgz

# è§£å‹
tar -xzf kafka_2.13-3.7.0.tgz

# è¿›å…¥ç›®å½•
cd kafka_2.13-3.7.0
```

#### æ–¹æ³• Bï¼šæ‰‹åŠ¨ä¸‹è½½

1. è®¿é—® Apache Kafka å®˜ç½‘ï¼šhttps://kafka.apache.org/downloads
2. ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼ˆæ¨è `kafka_2.13-3.7.0.tgz`ï¼‰
3. è§£å‹åˆ°ç›®æ ‡ç›®å½•

```bash
tar -xzf kafka_2.13-3.7.0.tgz
cd kafka_2.13-3.7.0
```

---

### 3. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# ç¼–è¾‘ ~/.bashrc æˆ– ~/.zshrc
nano ~/.bashrc

# æ·»åŠ ä»¥ä¸‹å†…å®¹
export KAFKA_HOME=~/kafka/kafka_2.13-3.7.0
export PATH=$PATH:$KAFKA_HOME/bin

# ä½¿é…ç½®ç”Ÿæ•ˆ
source ~/.bashrc

# éªŒè¯
kafka-topics.sh --version
```

---

### 4. å¯åŠ¨ Kafkaï¼ˆKRaft æ¨¡å¼ï¼Œæ— éœ€ Zookeeperï¼‰

**Kafka 3.3+ æ”¯æŒ KRaft æ¨¡å¼ï¼Œä¸å†éœ€è¦ Zookeeperï¼**

#### æ­¥éª¤ 1ï¼šç”Ÿæˆé›†ç¾¤ ID

```bash
cd ~/kafka/kafka_2.13-3.7.0

# ç”Ÿæˆé›†ç¾¤ UUID
KAFKA_CLUSTER_ID=$(bin/kafka-storage.sh random-uuid)
echo "Cluster ID: $KAFKA_CLUSTER_ID"
```

#### æ­¥éª¤ 2ï¼šæ ¼å¼åŒ–å­˜å‚¨ç›®å½•

```bash
# æ ¼å¼åŒ–æ—¥å¿—ç›®å½•ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
bin/kafka-storage.sh format \
  -t $KAFKA_CLUSTER_ID \
  -c config/kraft/server.properties
```

#### æ­¥éª¤ 3ï¼šå¯åŠ¨ Kafka æœåŠ¡å™¨

```bash
# å¯åŠ¨ Kafkaï¼ˆå‰å°è¿è¡Œï¼Œç”¨äºæµ‹è¯•ï¼‰
bin/kafka-server-start.sh config/kraft/server.properties

# æˆ–è€…åå°è¿è¡Œ
nohup bin/kafka-server-start.sh config/kraft/server.properties > kafka.log 2>&1 &
```

**éªŒè¯ Kafka æ˜¯å¦å¯åŠ¨æˆåŠŸ**ï¼š

```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep kafka

# æ£€æŸ¥ç«¯å£ï¼ˆKafka é»˜è®¤ç«¯å£ 9092ï¼‰
netstat -tlnp | grep 9092
# æˆ–
ss -tlnp | grep 9092
```

---

### 5. æµ‹è¯• Kafka

#### åˆ›å»º Topic

```bash
# åˆ›å»ºæµ‹è¯• Topic
bin/kafka-topics.sh --create \
  --topic sol-trades \
  --bootstrap-server localhost:9092 \
  --partitions 3 \
  --replication-factor 1

# æŸ¥çœ‹æ‰€æœ‰ Topic
bin/kafka-topics.sh --list --bootstrap-server localhost:9092

# æŸ¥çœ‹ Topic è¯¦æƒ…
bin/kafka-topics.sh --describe \
  --topic sol-trades \
  --bootstrap-server localhost:9092
```

#### å‘é€æ¶ˆæ¯ï¼ˆProducerï¼‰

```bash
# æ‰“å¼€ç»ˆç«¯ 1ï¼šå¯åŠ¨ Producer
bin/kafka-console-producer.sh \
  --topic sol-trades \
  --bootstrap-server localhost:9092

# è¾“å…¥æ¶ˆæ¯åæŒ‰å›è½¦å‘é€ï¼Œä¾‹å¦‚ï¼š
# {"trade_id": "123", "pair": "SOL/USDC", "price": 100.5, "amount": 10.0}
# {"trade_id": "124", "pair": "SOL/USDC", "price": 100.6, "amount": 5.0}
# æŒ‰ Ctrl+C é€€å‡º
```

#### æ¶ˆè´¹æ¶ˆæ¯ï¼ˆConsumerï¼‰

```bash
# æ‰“å¼€ç»ˆç«¯ 2ï¼šå¯åŠ¨ Consumerï¼ˆä»å¼€å§‹ä½ç½®æ¶ˆè´¹ï¼‰
bin/kafka-console-consumer.sh \
  --topic sol-trades \
  --bootstrap-server localhost:9092 \
  --from-beginning

# æˆ–è€…ä»æœ€æ–°ä½ç½®å¼€å§‹æ¶ˆè´¹
bin/kafka-console-consumer.sh \
  --topic sol-trades \
  --bootstrap-server localhost:9092

# æŒ‰ Ctrl+C åœæ­¢æ¶ˆè´¹
```

---

### 6. åœæ­¢ Kafka

```bash
# å¦‚æœå‰å°è¿è¡Œï¼ŒæŒ‰ Ctrl+C

# å¦‚æœåå°è¿è¡Œï¼ŒæŸ¥æ‰¾è¿›ç¨‹å¹¶åœæ­¢
ps aux | grep kafka
kill <PID>

# æˆ–è€…ä½¿ç”¨ pkill
pkill -f kafka-server-start
```

---

## ğŸ³ æ–¹å¼äºŒï¼šä½¿ç”¨ Docker è¿è¡Œ Kafkaï¼ˆæ¨èï¼‰

### 1. å¯åŠ¨ Kafkaï¼ˆä½¿ç”¨ Dockerï¼‰

```bash
# æ³¨æ„ï¼šKafka 3.3+ ç‰ˆæœ¬ä½¿ç”¨ KRaft æ¨¡å¼ï¼Œä¸å†éœ€è¦ Zookeeper
docker run -d \
  --name kafka \
  -p 9092:9092 \
  apache/kafka:latest
```

**æˆ–è€…ä½¿ç”¨ Docker Composeï¼ˆæ¨èï¼‰**ï¼š

åˆ›å»º `docker-compose.yml`ï¼š

```yaml
version: '3.8'
services:
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:29093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:29093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
    volumes:
      - ./kafka-data:/tmp/kraft-combined-logs  # æ•°æ®æŒä¹…åŒ–
```

å¯åŠ¨ï¼š

```bash
docker-compose up -d
```

---

### 2. åˆ›å»º Topic

```bash
# è·å–å®¹å™¨åç§°æˆ– ID
docker ps | grep kafka

# åˆ›å»º Topic
docker exec -it kafka /opt/kafka/bin/kafka-topics.sh \
  --create \
  --topic sol-trades \
  --bootstrap-server localhost:9092 \
  --partitions 3 \
  --replication-factor 1
```

---

### 3. å‘é€æµ‹è¯•æ¶ˆæ¯ï¼ˆProducerï¼‰

```bash
docker exec -it kafka /opt/kafka/bin/kafka-console-producer.sh \
  --topic sol-trades \
  --bootstrap-server localhost:9092

# è¾“å…¥æ¶ˆæ¯åæŒ‰å›è½¦å‘é€ï¼Œè¾“å…¥å¤šè¡Œæ¶ˆæ¯ï¼ŒæŒ‰ Ctrl+C é€€å‡º
# ç¤ºä¾‹æ¶ˆæ¯ï¼š
# {"trade_id": "123", "pair": "SOL/USDC", "price": 100.5, "amount": 10.0}
# {"trade_id": "124", "pair": "SOL/USDC", "price": 100.6, "amount": 5.0}
```

---

### 4. æ¶ˆè´¹æµ‹è¯•æ¶ˆæ¯ï¼ˆConsumerï¼‰

```bash
# ä»å¼€å§‹ä½ç½®æ¶ˆè´¹
docker exec -it kafka /opt/kafka/bin/kafka-console-consumer.sh \
  --topic sol-trades \
  --bootstrap-server localhost:9092 \
  --from-beginning

# æŒ‰ Ctrl+C åœæ­¢æ¶ˆè´¹
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ç«¯å£ 9092 å·²è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo lsof -i :9092
# æˆ–
sudo netstat -tlnp | grep 9092

# åœæ­¢å ç”¨è¿›ç¨‹æˆ–ä¿®æ”¹ Kafka é…ç½®ä¸­çš„ç«¯å£
```

ä¿®æ”¹ `config/kraft/server.properties`ï¼š

```properties
listeners=PLAINTEXT://:9093  # æ”¹ä¸ºå…¶ä»–ç«¯å£
advertised.listeners=PLAINTEXT://localhost:9093
```

---

### Q2: Java ç‰ˆæœ¬ä¸å…¼å®¹

**é”™è¯¯ä¿¡æ¯**ï¼š`UnsupportedClassVersionError` æˆ– `java.lang.UnsupportedClassVersionError`

**è§£å†³æ–¹æ¡ˆ**ï¼šå®‰è£… Java 17+

```bash
# Ubuntu/Debian
sudo apt install openjdk-17-jdk -y

# è®¾ç½® JAVA_HOME
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
```

---

### Q3: æƒé™é—®é¢˜

**é”™è¯¯ä¿¡æ¯**ï¼š`Permission denied`

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x bin/*.sh

# æˆ–è€…ä½¿ç”¨ sudoï¼ˆä¸æ¨èï¼‰
```

---

### Q4: æ•°æ®ç›®å½•ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /tmp/kraft-combined-logs

# æˆ–è€…ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ log.dirs
```

---

## ğŸ“ å¿«é€Ÿå‚è€ƒå‘½ä»¤

### æœ¬åœ°å®‰è£…

```bash
# å¯åŠ¨ Kafka
cd ~/kafka/kafka_2.13-3.7.0
bin/kafka-server-start.sh config/kraft/server.properties

# åˆ›å»º Topic
bin/kafka-topics.sh --create --topic sol-trades --bootstrap-server localhost:9092

# å‘é€æ¶ˆæ¯
bin/kafka-console-producer.sh --topic sol-trades --bootstrap-server localhost:9092

# æ¶ˆè´¹æ¶ˆæ¯
bin/kafka-console-consumer.sh --topic sol-trades --bootstrap-server localhost:9092 --from-beginning
```

### Docker å®‰è£…

```bash
# å¯åŠ¨
docker run -d --name kafka -p 9092:9092 apache/kafka:latest

# åˆ›å»º Topic
docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --create --topic sol-trades --bootstrap-server localhost:9092

# å‘é€æ¶ˆæ¯
docker exec -it kafka /opt/kafka/bin/kafka-console-producer.sh --topic sol-trades --bootstrap-server localhost:9092

# æ¶ˆè´¹æ¶ˆæ¯
docker exec -it kafka /opt/kafka/bin/kafka-console-consumer.sh --topic sol-trades --bootstrap-server localhost:9092 --from-beginning
```

---

## âœ… éªŒè¯å®‰è£…æˆåŠŸ

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ Kafka æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```bash
# 1. æ£€æŸ¥ Kafka è¿›ç¨‹
ps aux | grep kafka  # æœ¬åœ°å®‰è£…
# æˆ–
docker ps | grep kafka  # Docker å®‰è£…

# 2. æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 9092

# 3. åˆ—å‡º Topic
# æœ¬åœ°å®‰è£…
bin/kafka-topics.sh --list --bootstrap-server localhost:9092

# Docker å®‰è£…
docker exec kafka /opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092
```

å¦‚æœèƒ½çœ‹åˆ° Kafka è¿›ç¨‹è¿è¡Œä¸”ç«¯å£æ­£å¸¸ç›‘å¬ï¼Œè¯´æ˜å®‰è£…æˆåŠŸï¼ğŸ‰
