录制：redis基础8_hashTable数据结构.mp4
日期：2026-01-30 22:41:13
录制文件：https://meeting.tencent.com/crm/2jYVGxZ572

Q1: 哈希表数据结构
是基于  dict (字典) 数据结构来实现的。 

1）什么是字典？
字典可以理解为一个map (key,value). 

2）字典数据结构
ht_table[0] : 主哈希表
ht_table[1] : 扩容时的临时哈希表 
ht_used[0] : 主表已使用的槽位数
ht_used[1] : 临时表已使用的槽位数
rehashidx : rehash 进度索引 

3) ht_table 
是一个指针数组，每个元素指向一个 ‘dictEntry’链表
数组大小是2的幂次
通过hash(field) & sizemask计算索引

4）dictEntry 哈希表节点
struct dictEntry{
    dictEntry *next;  //指向下一个节点
    void *key/   //field (字段名)
    union{
        void *val;  //value (字段值)
        uint64_t u64;
        int64_t s64;
        doube d;
    } v;
}; 

5) 字典，哈希表和哈希节点关系？
┌─────────────────────────────────────────┐
│ type: dictType                          │
│ ht_table[0]: ────────────────────────┐ │
│ ht_table[1]: NULL (未扩容时)          │ │
│ ht_used[0]: 2                          │ │
│ ht_used[1]: 0                          │ │
│ rehashidx: -1 (未在 rehash)            │ │
│ ht_size_exp[0]: 2 (size = 2^2 = 4)     │ │
└─────────────────────────────────────────┘ │
                                             │
         ┌───────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│ 哈希表数组 ht_table[0]                   │
├─────────────────────────────────────────┤
│ table[0]: NULL                          │
│ table[1]: dictEntry* ─────────────────┐ │
│ table[2]: dictEntry* ────────────────┐ │ │
│ table[3]: NULL                      │ │ │
└──────────────────────────────────────┘ │ │
                                         │ │
         ┌───────────────────────────────┘ │
         │                                 │
         ▼                                 ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│ dictEntry 1              │  │ dictEntry 2              │
├──────────────────────────┤  ├──────────────────────────┤
│ next: NULL               │  │ next: NULL                │
│ key: SDS("name")         │  │ key: SDS("age")          │
│ val: SDS("Alice")        │  │ val: SDS("25")           │
└──────────────────────────┘  └──────────────────────────┘
```


Q2: 数据是如何存储到哈希表结构？
举例： HSET user:1001 name "Alice" age "25"
第一步：先计算field哈希值
hash_value = hash("name") //假设得到12345
hash_value = hash("age") //假设得到67890

第二步： 计算数组索引
假设哈希表大小为4 
sizemask = 4-1 =3 //二进制： 11 

index1 = 12345 & 3 = 1 // "name"存储在table[1]
index2 = 67890 & 3 = 2 // "age"存储在table[2]

第三步：创建dictEntry节点
dictEntry *entry1 = malloc(sizeof(dictEntry));
entry1 -> key = SDS("name");
entry1 -> value = SDS("Alice");
entry1 -> next = NULL;

// 为 "age" 创建节点
dictEntry *entry2 = malloc(sizeof(dictEntry));
entry2->key = SDS("age");
entry2->val = SDS("25");
entry2->next = NULL;

第四步: 插入到哈希表
table[1] = entry1; 
table[2] = entry2;

内存图： 
哈希表数组（大小为 4）：
┌─────────────────────────────────────────┐
│ table[0]: NULL                          │
│ table[1]: ────────────────────────────┐ │
│ table[2]: ─────────────────────────┐ │ │
│ table[3]: NULL                      │ │ │
└──────────────────────────────────────┘ │ │
                                         │ │
         ┌───────────────────────────────┘ │
         │                                 │
         ▼                                 ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│ dictEntry ("name")       │  │ dictEntry ("age")       │
├──────────────────────────┤  ├──────────────────────────┤
│ next: NULL               │  │ next: NULL               │
│ key: ──────────────────┐ │  │ key: ──────────────────┐ │
│ val: ─────────────────┐ │ │  │ val: ─────────────────┐ │ │
└────────────────────────┘ │ │  └────────────────────────┘ │ │
                          │ │                           │ │
         ┌────────────────┘ │            ┌──────────────┘ │
         │                   │            │                │
         ▼                   │            ▼                │
┌──────────────────┐         │  ┌──────────────────┐      │
│ SDS("name")      │         │  │ SDS("age")       │      │
│ len: 4           │         │  │ len: 3           │      │
│ "name\0"         │         │  │ "age\0"          │      │
└──────────────────┘         │  └──────────────────┘      │
                             │                            │
         ┌───────────────────┘            ┌─────────────────┘
         │                                │
         ▼                                ▼
┌──────────────────┐         ┌──────────────────┐
│ SDS("Alice")     │         │ SDS("25")        │
│ len: 5           │         │ len: 2           │
│ "Alice\0"        │         │ "25\0"           │
└──────────────────┘         └──────────────────┘
```

Q3: HashTable和ZipList对比
1）内存布局：
zipList是连续内存； hashTable是非连续(指针连接)
2） 查找方式： zipList顺序遍历； 哈希定位
...
