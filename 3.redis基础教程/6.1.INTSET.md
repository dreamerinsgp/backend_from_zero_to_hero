录制：redis基础10_INSET底层数据结构.mp4
日期：2026-01-30 22:39:25
录制文件：https://meeting.tencent.com/crm/KD5Q3JPxc6

Q1： 什么是INTSET?
INTSET是一个有序的，紧凑的整数数组，用于存储小规模的整数集合。 

Q2: INTSET数据结构
typedef struct inteset{
    uint32_t encoding; //编码类型： INTSET_ENC_INT16/INT32/INT64
    uint32_t length;  //元素数量
    int8_t contents[]; //整数数组 
} 
字段含义
1) ： encoding: 编码类型，决定每个整数占用的字节数
举例： INTSET_ENC_INT16 = 2 ： 每个整数两个字节 (-32768 到32767)

2）： length: 当前存储的整数个数

3）：contents[] : 实际存储整数的连续内存空间

Q3: INTSET内存布局
实例1： 存储[1,3,5]  (INT16编码)
┌─────────────────────────────────────────┐
│ intset 结构                              │
├─────────────────────────────────────────┤
│ encoding: INTSET_ENC_INT16 (2)          │ 4 字节
│ length: 3                               │ 4 字节
│ contents[0]: 1 (int16_t)               │ 2 字节
│ contents[1]: 3 (int16_t)               │ 2 字节
│ contents[2]: 5 (int16_t)               │ 2 字节
└─────────────────────────────────────────┘

Q4: INTSET优缺点
1）优点
-内存紧凑：连续内存存储，无指针开销
-有序存储：元素按从小到大排序，支持二分查找
-自动升级：根据数值范围自动选择最合适的编码
-查找高效：二分查找O(logn)

2) 缺点
- 插入/删除慢：需要移动元素，O(n)时间复杂度


Q5:数据是如何存储到INTSET结构？ 
举例： SADD numbers 1 3 5 
第一步： 创建空的INTSET
intset *is = intsetNew()
// encoding =  INTSET_ENC_INT16 (默认最小编码)
// length = 0 
// contents[] = 空

第二步：添加元素1
intsetAdd(is, 1, &success)
//1. 检查编码： 1在INT16范围内，无需升级
//2. 二分查找插入位置： pos =0 (空集合，插入到开头)
//3. 调整大小： length = 1
//4. 设置值: contents[0] = 1

第三步：添加元素3
intsetAdd(is, 3, &success);
// 1. 检查编码：3 在 INT16 范围内，无需升级
// 2. 二分查找插入位置：pos = 1（1 < 3，插入到位置1）
// 3. 移动元素：contents[1] = contents[0]（不需要，因为插入在末尾）
// 4. 调整大小：length = 2
// 5. 设置值：contents[1] = 3

第四步：添加元素5
intsetAdd(is, 5, &success);
// 1. 检查编码：5 在 INT16 范围内，无需升级
// 2. 二分查找插入位置：pos = 2（3 < 5，插入到位置2）
// 3. 调整大小：length = 3
// 4. 设置值：contents[2] = 5

最终内存布局**：
```
┌─────────────────────────────────────────┐
│ encoding: INTSET_ENC_INT16 (2)          │
│ length: 3                               │
│ contents[0]: 1                          │
│ contents[1]: 3                          │
│ contents[2]: 5                          │
└─────────────────────────────────────────┘