# Redis Hash 命令测试用例
# 使用方法: redis-cli < 2.hash_commands.redis
# 或逐条复制命令到 redis-cli 中执行

# ============================================
# 测试1: HSET/HGET - 基本设置和获取字段
# ============================================

# 设置单个字段
HSET user:1001 name "Alice"
HSET user:1001 age "25"
HSET user:1001 email "alice@example.com"

# 获取单个字段
HGET user:1001 name
HGET user:1001 age
HGET user:1001 email

# 获取不存在的字段
HGET user:1001 phone

# 覆盖已存在的字段
HSET user:1001 age "26"
HGET user:1001 age

# 一次设置多个字段
HSET user:1002 name "Bob" age "30" email "bob@example.com"
HGET user:1002 name
HGET user:1002 age

# ============================================
# 测试2: HGETALL - 获取所有字段和值
# ============================================

# 获取用户1001的所有信息
HGETALL user:1001

# 获取用户1002的所有信息
HGETALL user:1002

# 获取不存在的Hash
HGETALL user:9999

# ============================================
# 测试3: HDEL - 删除字段
# ============================================

# 删除单个字段
HDEL user:1001 email
HGETALL user:1001

# 删除多个字段
HDEL user:1002 name email
HGETALL user:1002

# 删除不存在的字段（返回0，不影响）
HDEL user:1001 nonexistent
HGETALL user:1001

# ============================================
# 测试4: HKEYS - 获取所有字段名
# ============================================

# 获取所有字段名
HKEYS user:1001

# 重新设置完整用户信息
HSET user:1001 name "Alice" age "26" city "Beijing" country "China"
HKEYS user:1001

# 获取不存在的Hash的字段名
HKEYS user:9999

# ============================================
# 测试5: HVALS - 获取所有字段值
# ============================================

# 获取所有字段值
HVALS user:1001

# 获取用户1002的所有值
HVALS user:1002

# 获取不存在的Hash的值
HVALS user:9999

# ============================================
# 测试6: HEXISTS - 检查字段是否存在
# ============================================

# 检查存在的字段
HEXISTS user:1001 name
HEXISTS user:1001 age

# 检查不存在的字段
HEXISTS user:1001 phone
HEXISTS user:9999 name

# ============================================
# 测试7: HLEN - 获取字段数量
# ============================================

# 获取字段数量
HLEN user:1001
HLEN user:1002

# 获取不存在的Hash的字段数量
HLEN user:9999

# ============================================
# 测试8: HMSET/HMGET - 批量设置和获取
# ============================================

# 批量设置多个字段（HMSET在Redis 4.0.0+中已废弃，使用HSET代替）
HSET user:1003 name "Charlie" age "28" email "charlie@example.com" city "Shanghai"

# 批量获取多个字段
HMGET user:1003 name age email city

# 批量获取部分存在的字段
HMGET user:1003 name phone age

# ============================================
# 测试9: HINCRBY - 字段值递增
# ============================================

# 设置数字字段
HSET counter:user:1001 page_views 100
HGET counter:user:1001 page_views

# 递增操作
HINCRBY counter:user:1001 page_views 5
HGET counter:user:1001 page_views

# 递减操作（使用负数）
HINCRBY counter:user:1001 page_views -10
HGET counter:user:1001 page_views

# 对不存在的字段执行递增（自动初始化为0）
HINCRBY counter:user:1001 likes 1
HGET counter:user:1001 likes

# ============================================
# 测试10: HINCRBYFLOAT - 浮点数递增
# ============================================

# 设置浮点数字段
HSET token:0x123 balance 1000.5
HGET token:0x123 balance

# 浮点数递增
HINCRBYFLOAT token:0x123 balance 50.25
HGET token:0x123 balance

# 浮点数递减
HINCRBYFLOAT token:0x123 balance -100.75
HGET token:0x123 balance

# ============================================
# 测试11: HSETNX - 仅当字段不存在时设置
# ============================================

# 第一次设置（成功）
HSETNX user:1004 name "David"
HGET user:1004 name

# 再次尝试设置（失败，因为字段已存在）
HSETNX user:1004 name "David2"
HGET user:1004 name

# 设置新字段（成功）
HSETNX user:1004 age "32"
HGETALL user:1004

# ============================================
# 测试12: WebSocket订阅管理场景模拟
# ============================================

# 用户订阅频道（参考 redischannel.go）
HSET websocket:subs:user:1001 channel:btc "subscribed"
HSET websocket:subs:user:1001 channel:eth "subscribed"
HSET websocket:subs:user:1001 channel:sol "subscribed"

# 获取用户的所有订阅（HGETALL）
HGETALL websocket:subs:user:1001

# 取消某个订阅（HDEL）
HDEL websocket:subs:user:1001 channel:eth
HGETALL websocket:subs:user:1001

# 获取所有订阅的频道名（HKEYS）
HKEYS websocket:subs:user:1001

# ============================================
# 测试13: 用户信息存储对比（Hash vs String JSON）
# ============================================

# 方式1: 使用Hash存储用户信息（推荐）
HSET user:hash:1001 name "Alice" age "25" email "alice@example.com" city "Beijing"
HGETALL user:hash:1001

# 只更新单个字段（高效）
HSET user:hash:1001 age "26"
HGET user:hash:1001 age

# 方式2: 使用String存储JSON（对比）
SET user:string:1001 '{"name":"Alice","age":"25","email":"alice@example.com","city":"Beijing"}'
GET user:string:1001

# 更新需要获取整个JSON，修改后再设置（低效）
# 实际项目中需要序列化/反序列化操作

# ============================================
# 测试14: 交易信息存储（项目场景）
# ============================================

# 存储交易信息
HSET tx:0xABC123 hash "0xABC123" from "0x111" to "0x222" amount "1000" status "pending"
HGETALL tx:0xABC123

# 更新交易状态
HSET tx:0xABC123 status "confirmed"
HGET tx:0xABC123 status

# 添加确认时间
HSET tx:0xABC123 confirmed_at "2024-01-15T10:30:00Z"
HGETALL tx:0xABC123

# ============================================
# 测试15: 代币余额管理（多代币场景）
# ============================================

# 用户持有多种代币
HSET balance:user:1001 USDT "1000.5"
HSET balance:user:1001 USDC "500.25"
HSET balance:user:1001 ETH "2.5"

# 获取所有代币余额
HGETALL balance:user:1001

# 查询特定代币余额
HGET balance:user:1001 USDT

# 转账操作（减少USDT，增加USDC）
HINCRBYFLOAT balance:user:1001 USDT -100.0
HINCRBYFLOAT balance:user:1001 USDC 100.0
HGETALL balance:user:1001

# ============================================
# 测试16: 嵌套对象存储（使用字段名模拟）
# ============================================

# 存储订单信息（包含多个字段）
HSET order:1001 order_id "1001" user_id "2001" amount "99.99" currency "USDT" status "paid"
HSET order:1001 created_at "2024-01-15T10:00:00Z" updated_at "2024-01-15T10:05:00Z"

# 获取订单所有信息
HGETALL order:1001

# 更新订单状态和时间
HSET order:1001 status "shipped" updated_at "2024-01-15T11:00:00Z"
HGETALL order:1001

# ============================================
# 测试17: 统计信息存储
# ============================================

# 存储API调用统计
HSET stats:api:getBlockInfo total_calls 1000 success_calls 950 failed_calls 50
HSET stats:api:getBlockInfo avg_response_time "120ms" last_call_time "2024-01-15T10:30:00Z"

# 获取统计信息
HGETALL stats:api:getBlockInfo

# 增加调用次数
HINCRBY stats:api:getBlockInfo total_calls 1
HINCRBY stats:api:getBlockInfo success_calls 1
HGET stats:api:getBlockInfo total_calls

# ============================================
# 测试18: 字段存在性检查（条件操作）
# ============================================

# 检查用户是否有邮箱
HEXISTS user:1001 email

# 如果没有邮箱则设置
HSETNX user:1001 email "newemail@example.com"
HGET user:1001 email

# 再次尝试（不会覆盖）
HSETNX user:1001 email "another@example.com"
HGET user:1001 email

# ============================================
# 测试19: 批量操作性能对比
# ============================================

# Hash批量设置（高效）
HSET product:1001 name "Product A" price "99.99" stock "100" category "Electronics"

# Hash批量获取（高效）
HMGET product:1001 name price stock category

# 对比：如果用String存储，需要序列化整个对象
# SET product:string:1001 '{"name":"Product A","price":"99.99","stock":"100","category":"Electronics"}'
# 更新单个字段需要反序列化、修改、再序列化

# ============================================
# 测试20: Hash过期时间（对整个Hash设置）
# ============================================

# 设置Hash
HSET session:user:1001 token "abc123" user_id "1001" expires_at "2024-01-16T10:00:00Z"

# 设置整个Hash的过期时间
EXPIRE session:user:1001 3600
TTL session:user:1001

# 获取Hash内容
HGETALL session:user:1001

# 检查过期时间
TTL session:user:1001

# ============================================
# 清理测试数据（可选）
# ============================================

# DEL user:1001 user:1002 user:1003 user:1004 counter:user:1001 token:0x123 websocket:subs:user:1001 user:hash:1001 user:string:1001 tx:0xABC123 balance:user:1001 order:1001 stats:api:getBlockInfo product:1001 session:user:1001
