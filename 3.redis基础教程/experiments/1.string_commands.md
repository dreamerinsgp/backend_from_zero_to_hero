# Redis String 命令测试用例
# 使用方法: redis-cli < 1.string_commands.redis
# 或逐条复制命令到 redis-cli 中执行

# ============================================
# 测试1: SET/GET - 基本设置和获取
# ============================================

SET user:1001:name "Alice"
GET user:1001:name

# 获取不存在的键
GET user:1002:name

# 覆盖已存在的值
SET user:1001:name "Bob"
GET user:1001:name

# 设置数字字符串
SET counter "100"
GET counter

# 设置 JSON 字符串
SET tokeninfo:1:0x123 '{"name":"USDT","symbol":"USDT","decimals":18}'
GET tokeninfo:1:0x123

# ============================================
# 测试2: SETEX - 设置值并指定过期时间
# ============================================

# 设置10秒过期
SETEX cache:user:1001 10 "cached_data"
GET cache:user:1001
TTL cache:user:1001

# 设置24小时过期（HTTP缓存场景）
SETEX cache:oklink:http:abc123 86400 "http_response_data"
TTL cache:oklink:http:abc123

# 设置30天过期（Token缓存场景）
SETEX tokeninfo:1:0x456 2592000 "token_data"
TTL tokeninfo:1:0x456

# ============================================
# 测试3: SETNX - 仅当键不存在时设置
# ============================================

# 第一次设置（成功）
SETNX lock:order:1001 "locked"

# 再次尝试设置（失败，因为键已存在）
SETNX lock:order:1001 "locked"

# 获取值确认
GET lock:order:1001

# 删除锁后再次设置
DEL lock:order:1001
SETNX lock:order:1001 "locked_again"
GET lock:order:1001

# ============================================
# 测试4: SET NX EX - 带过期时间的原子设置
# ============================================

# 使用新语法（Redis 2.6.12+）
SET tokeninfo:1:0x789 "token_data" NX EX 3600
GET tokeninfo:1:0x789
TTL tokeninfo:1:0x789

# 再次尝试（键已存在，不会覆盖）
SET tokeninfo:1:0x789 "new_token_data" NX EX 3600
GET tokeninfo:1:0x789

# 删除后重新设置
DEL tokeninfo:1:0x789
SET tokeninfo:1:0x789 "new_token_data" NX EX 3600
GET tokeninfo:1:0x789

# ============================================
# 测试5: INCR - 递增操作
# ============================================

# 对不存在的键执行 INCR（自动初始化为0后递增）
INCR counter:page:views
INCR counter:page:views
INCR counter:page:views
GET counter:page:views

# 指定增量递增
INCRBY counter:page:views 5
GET counter:page:views

# 递减操作
DECR counter:page:views
DECRBY counter:page:views 3
GET counter:page:views

# 浮点数递增（Redis 2.6+）
INCRBYFLOAT counter:price 0.5
INCRBYFLOAT counter:price 1.2
GET counter:price

# API调用计数（项目场景）
INCR helius:consumer:getBlockInfo
INCR helius:consumer:getBlockInfo
GET helius:consumer:getBlockInfo

# ============================================
# 测试6: EXPIRE/TTL - 过期时间管理
# ============================================

# 先设置一个值
SET session:user:1001 "session_data"

# 设置过期时间（60秒）
EXPIRE session:user:1001 60
TTL session:user:1001

# 查看过期时间（毫秒）
PTTL session:user:1001

# 取消过期时间（永久保存）
PERSIST session:user:1001
TTL session:user:1001

# 重新设置过期时间
EXPIRE session:user:1001 30
TTL session:user:1001

# 使用 EXPIREAT 设置绝对过期时间
EXPIREAT session:user:1001 1735689600
TTL session:user:1001

# ============================================
# 测试7: Cache-Aside 模式模拟
# ============================================

# 第一次查询（缓存未命中）
GET tokeninfo:1:0xABC

# 模拟从数据库获取数据后写入缓存（30天）
SETEX tokeninfo:1:0xABC 2592000 '{"name":"USDT","symbol":"USDT","decimals":18}'

# 第二次查询（缓存命中）
GET tokeninfo:1:0xABC
TTL tokeninfo:1:0xABC

# 模拟缓存更新（先删除再设置）
DEL tokeninfo:1:0xABC
SETEX tokeninfo:1:0xABC 2592000 '{"name":"USDT","symbol":"USDT","decimals":18,"updated":true}'
GET tokeninfo:1:0xABC

# ============================================
# 测试8: 分布式锁模拟
# ============================================

# 获取锁（带过期时间，防止死锁）
SET lock:checkOnChainTx "locked" NX EX 60
GET lock:checkOnChainTx
TTL lock:checkOnChainTx

# 其他进程尝试获取锁（失败）
SET lock:checkOnChainTx "locked2" NX EX 60

# 锁持有者完成任务后释放锁
DEL lock:checkOnChainTx

# 其他进程再次尝试（成功）
SET lock:checkOnChainTx "locked2" NX EX 60
GET lock:checkOnChainTx

# ============================================
# 清理测试数据（可选）
# ============================================

# DEL user:1001:name user:1002:name counter tokeninfo:1:0x123 cache:user:1001 lock:order:1001 tokeninfo:1:0x789 counter:page:views counter:price helius:consumer:getBlockInfo session:user:1001 tokeninfo:1:0xABC lock:checkOnChainTx
