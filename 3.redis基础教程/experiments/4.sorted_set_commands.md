# Redis Sorted Set 命令测试用例
# 使用方法: redis-cli < 4.sorted_set_commands.redis
# 或逐条复制命令到 redis-cli 中执行

# ============================================
# 测试1: ZADD - 添加成员和分数
# ============================================

# 添加单个成员
ZADD leaderboard 100 "Alice"
ZADD leaderboard 200 "Bob"
ZADD leaderboard 150 "Charlie"

# 添加多个成员（一次添加）
ZADD leaderboard 180 "David" 120 "Eve" 90 "Frank"

# 更新已存在成员的分数
ZADD leaderboard 250 "Alice"
ZSCORE leaderboard "Alice"

# 查看所有成员（按分数升序）
ZRANGE leaderboard 0 -1

# 查看所有成员（带分数）
ZRANGE leaderboard 0 -1 WITHSCORES

# ============================================
# 测试2: ZRANGE - 按排名范围查询（升序）
# ============================================

# 获取前3名（排名从0开始）
ZRANGE leaderboard 0 2

# 获取所有成员
ZRANGE leaderboard 0 -1

# 获取最后3名
ZRANGE leaderboard -3 -1

# 获取带分数的结果
ZRANGE leaderboard 0 2 WITHSCORES

# 获取排名范围内的成员数量
ZRANGE leaderboard 0 4

# ============================================
# 测试3: ZREVRANGE - 按排名范围查询（降序）
# ============================================

# 获取前3名（分数从高到低）
ZREVRANGE leaderboard 0 2

# 获取所有成员（降序）
ZREVRANGE leaderboard 0 -1

# 获取带分数的结果
ZREVRANGE leaderboard 0 2 WITHSCORES

# 获取最后3名（分数最低的）
ZREVRANGE leaderboard -3 -1

# ============================================
# 测试4: ZRANGEBYSCORE - 按分数范围查询（重要！）
# ============================================

# 查询分数在 100 到 200 之间的成员
ZRANGEBYSCORE leaderboard 100 200

# 查询分数在 100 到 200 之间的成员（带分数）
ZRANGEBYSCORE leaderboard 100 200 WITHSCORES

# 查询分数 >= 150 的成员
ZRANGEBYSCORE leaderboard 150 +inf

# 查询分数 <= 150 的成员
ZRANGEBYSCORE leaderboard -inf 150

# 查询分数 > 100 且 < 200 的成员（不包含边界）
ZRANGEBYSCORE leaderboard (100 (200

# 查询分数 >= 100 且 <= 200 的成员（包含边界，默认）
ZRANGEBYSCORE leaderboard 100 200

# 限制返回数量
ZRANGEBYSCORE leaderboard 100 200 LIMIT 0 3

# ============================================
# 测试5: ZREM - 删除成员
# ============================================

# 删除单个成员
ZREM leaderboard "Frank"
ZRANGE leaderboard 0 -1

# 删除多个成员
ZREM leaderboard "Eve" "David"
ZRANGE leaderboard 0 -1

# 删除不存在的成员（返回0，不影响）
ZREM leaderboard "Nonexistent"

# ============================================
# 测试6: ZSCORE - 获取成员分数
# ============================================

# 获取成员的分数
ZSCORE leaderboard "Alice"
ZSCORE leaderboard "Bob"
ZSCORE leaderboard "Charlie"

# 获取不存在的成员的分数
ZSCORE leaderboard "Nonexistent"

# ============================================
# 测试7: ZRANK/ZREVRANK - 获取成员排名
# ============================================

# 获取成员排名（从0开始，分数升序）
ZRANK leaderboard "Alice"
ZRANK leaderboard "Bob"
ZRANK leaderboard "Charlie"

# 获取成员排名（从0开始，分数降序）
ZREVRANK leaderboard "Alice"
ZREVRANK leaderboard "Bob"
ZREVRANK leaderboard "Charlie"

# 获取不存在的成员的排名
ZRANK leaderboard "Nonexistent"

# ============================================
# 测试8: ZCARD - 获取集合成员数量
# ============================================

# 获取有序集合的成员数量
ZCARD leaderboard

# 获取不存在的集合的成员数量
ZCARD nonexistent:set

# ============================================
# 测试9: ZCOUNT - 统计分数范围内的成员数量
# ============================================

# 统计分数在 100 到 200 之间的成员数量
ZCOUNT leaderboard 100 200

# 统计分数 >= 150 的成员数量
ZCOUNT leaderboard 150 +inf

# 统计分数 <= 150 的成员数量
ZCOUNT leaderboard -inf 150

# ============================================
# 测试10: ZINCRBY - 增加成员分数
# ============================================

# 增加成员分数
ZINCRBY leaderboard 50 "Charlie"
ZSCORE leaderboard "Charlie"

# 减少成员分数（使用负数）
ZINCRBY leaderboard -30 "Bob"
ZSCORE leaderboard "Bob"

# 为新成员增加分数（自动创建）
ZINCRBY leaderboard 100 "NewUser"
ZSCORE leaderboard "NewUser"

# ============================================
# 测试11: ZREMRANGEBYRANK - 按排名范围删除
# ============================================

# 重新添加一些成员
ZADD leaderboard 100 "User1" 200 "User2" 300 "User3" 400 "User4" 500 "User5"

# 删除排名 0 到 2 的成员（前3名）
ZREMRANGEBYRANK leaderboard 0 2
ZRANGE leaderboard 0 -1

# 删除最后2名
ZREMRANGEBYRANK leaderboard -2 -1
ZRANGE leaderboard 0 -1

# ============================================
# 测试12: ZREMRANGEBYSCORE - 按分数范围删除
# ============================================

# 重新添加一些成员
ZADD leaderboard 100 "User1" 200 "User2" 300 "User3" 400 "User4" 500 "User5"

# 删除分数在 200 到 400 之间的成员
ZREMRANGEBYSCORE leaderboard 200 400
ZRANGE leaderboard 0 -1 WITHSCORES

# 删除分数 >= 500 的成员
ZREMRANGEBYSCORE leaderboard 500 +inf
ZRANGE leaderboard 0 -1

# ============================================
# 测试13: 排行榜功能实现（ZREVRANGE）
# ============================================

# 创建游戏排行榜
ZADD game:leaderboard 1000 "player1" 1500 "player2" 800 "player3" 2000 "player4" 1200 "player5"

# 获取前10名（TOP 10）
ZREVRANGE game:leaderboard 0 9 WITHSCORES

# 获取第1名
ZREVRANGE game:leaderboard 0 0 WITHSCORES

# 获取某个玩家的排名
ZREVRANK game:leaderboard "player2"

# 获取某个玩家的分数
ZSCORE game:leaderboard "player2"

# 玩家得分增加
ZINCRBY game:leaderboard 100 "player2"
ZSCORE game:leaderboard "player2"

# ============================================
# 测试14: K线数据查询（ZRANGEBYSCORE）- 项目场景
# ============================================

# 模拟K线数据：使用时间戳作为分数，K线数据作为成员
# 时间戳：2024-01-15 10:00:00 = 1705296000
ZADD kline:BTC:USDT:1m 1705296000 '{"open":50000,"high":50100,"low":49900,"close":50050,"volume":1000}'
ZADD kline:BTC:USDT:1m 1705296060 '{"open":50050,"high":50200,"low":50000,"close":50150,"volume":1200}'
ZADD kline:BTC:USDT:1m 1705296120 '{"open":50150,"high":50300,"low":50100,"close":50250,"volume":1500}'
ZADD kline:BTC:USDT:1m 1705296180 '{"open":50250,"high":50400,"low":50200,"close":50350,"volume":1800}'
ZADD kline:BTC:USDT:1m 1705296240 '{"open":50350,"high":50500,"low":50300,"close":50450,"volume":2000}'

# 查询指定时间范围的K线数据（参考 kline.go:59）
# 查询 10:00:00 到 10:05:00 的K线数据
ZRANGEBYSCORE kline:BTC:USDT:1m 1705296000 1705296300 WITHSCORES

# 查询最新的K线数据（最近5分钟）
ZRANGEBYSCORE kline:BTC:USDT:1m 1705296000 +inf WITHSCORES

# 查询历史K线数据（某个时间点之前）
ZRANGEBYSCORE kline:BTC:USDT:1m -inf 1705296120 WITHSCORES

# 限制返回数量（分页查询）
ZRANGEBYSCORE kline:BTC:USDT:1m 1705296000 +inf WITHSCORES LIMIT 0 10

# 统计某个时间范围内的K线数量
ZCOUNT kline:BTC:USDT:1m 1705296000 1705296300

# ============================================
# 测试15: 延迟队列实现（用分数表示执行时间）
# ============================================

# 使用时间戳作为分数，任务ID作为成员
# 当前时间戳：1705296000
# 10秒后执行的任务：1705296010
# 30秒后执行的任务：1705296030
# 60秒后执行的任务：1705296060

ZADD delay:queue 1705296010 "task:1001"
ZADD delay:queue 1705296030 "task:1002"
ZADD delay:queue 1705296060 "task:1003"
ZADD delay:queue 1705296120 "task:1004"

# 查询当前时间应该执行的任务（当前时间：1705296000，查询 <= 1705296010 的任务）
ZRANGEBYSCORE delay:queue -inf 1705296010 WITHSCORES

# 查询未来5分钟内要执行的任务
ZRANGEBYSCORE delay:queue 1705296000 1705296300 WITHSCORES

# 执行任务后删除
ZREMRANGEBYSCORE delay:queue -inf 1705296010
ZRANGE delay:queue 0 -1 WITHSCORES

# ============================================
# 测试16: ZPOPMAX/ZPOPMIN - 弹出最高/最低分成员
# ============================================

# 重新创建测试数据
ZADD test:pop 100 "a" 200 "b" 300 "c" 400 "d"

# 弹出分数最高的成员
ZPOPMAX test:pop
ZRANGE test:pop 0 -1

# 弹出分数最低的成员
ZPOPMIN test:pop
ZRANGE test:pop 0 -1

# 弹出多个最高分成员
ZPOPMAX test:pop 2
ZRANGE test:pop 0 -1

# ============================================
# 测试17: ZUNIONSTORE/ZINTERSTORE - 集合运算
# ============================================

# 创建两个有序集合
ZADD set1 10 "a" 20 "b" 30 "c"
ZADD set2 15 "b" 25 "c" 35 "d"

# 并集运算（相同成员的分数相加）
ZUNIONSTORE union:result 2 set1 set2
ZRANGE union:result 0 -1 WITHSCORES

# 交集运算（相同成员的分数相加）
ZINTERSTORE inter:result 2 set1 set2
ZRANGE inter:result 0 -1 WITHSCORES

# 并集运算（相同成员取最大分数）
ZUNIONSTORE union:max 2 set1 set2 AGGREGATE MAX
ZRANGE union:max 0 -1 WITHSCORES

# 并集运算（相同成员取最小分数）
ZUNIONSTORE union:min 2 set1 set2 AGGREGATE MIN
ZRANGE union:min 0 -1 WITHSCORES

# ============================================
# 测试18: ZSCAN - 迭代遍历有序集合
# ============================================

# 创建大量数据
ZADD scan:test 1 "member1" 2 "member2" 3 "member3" 4 "member4" 5 "member5"

# 开始扫描
ZSCAN scan:test 0

# 继续扫描（使用返回的游标）
# ZSCAN scan:test <cursor>

# 带匹配模式的扫描
ZSCAN scan:test 0 MATCH "member*"

# 限制返回数量
ZSCAN scan:test 0 COUNT 3

# ============================================
# 测试19: 时间序列数据存储（完整示例）
# ============================================

# 存储每小时的数据点（使用小时时间戳作为分数）
# 2024-01-15 00:00:00 = 1705276800
# 2024-01-15 01:00:00 = 1705280400
# 2024-01-15 02:00:00 = 1705284000

ZADD timeseries:hourly 1705276800 "data:2024-01-15:00:00"
ZADD timeseries:hourly 1705280400 "data:2024-01-15:01:00"
ZADD timeseries:hourly 1705284000 "data:2024-01-15:02:00"
ZADD timeseries:hourly 1705287600 "data:2024-01-15:03:00"
ZADD timeseries:hourly 1705291200 "data:2024-01-15:04:00"

# 查询某一天的数据（00:00:00 到 23:59:59）
ZRANGEBYSCORE timeseries:hourly 1705276800 1705363199 WITHSCORES

# 查询最近24小时的数据
ZRANGEBYSCORE timeseries:hourly 1705284000 +inf WITHSCORES

# 删除7天前的数据（数据清理）
ZREMRANGEBYSCORE timeseries:hourly -inf 1704672000

# ============================================
# 测试20: 多维度排序（使用组合分数）
# ============================================

# 使用组合分数：主分数 * 1000000 + 次分数
# 例如：优先级(主) * 1000000 + 时间戳(次)
# 优先级高的排在前面，相同优先级按时间排序

ZADD tasks 1000001 "task1"  # 优先级1，时间戳1
ZADD tasks 1000002 "task2"  # 优先级1，时间戳2
ZADD tasks 2000001 "task3"  # 优先级2，时间戳1
ZADD tasks 2000002 "task4"  # 优先级2，时间戳2

# 查询优先级1的所有任务
ZRANGEBYSCORE tasks 1000000 1999999 WITHSCORES

# 查询优先级2的所有任务
ZRANGEBYSCORE tasks 2000000 2999999 WITHSCORES

# ============================================
# 测试21: 过期数据清理（ZREMRANGEBYSCORE）
# ============================================

# 创建带时间戳的数据
ZADD cache:data 1705296000 "data1" 1705296100 "data2" 1705296200 "data3"
ZADD cache:data 1705296300 "data4" 1705296400 "data5"

# 当前时间：1705296500
# 删除5分钟前的数据（1705296500 - 300 = 1705296200）
ZREMRANGEBYSCORE cache:data -inf 1705296200
ZRANGE cache:data 0 -1 WITHSCORES

# ============================================
# 测试22: 有序集合的过期时间设置
# ============================================

# 创建有序集合
ZADD temp:sorted:set 100 "member1" 200 "member2"

# 设置过期时间（60秒）
EXPIRE temp:sorted:set 60
TTL temp:sorted:set

# 查看集合内容
ZRANGE temp:sorted:set 0 -1

# ============================================
# 测试23: 分数相同的成员排序
# ============================================

# 添加分数相同的成员
ZADD equal:score 100 "member1" 100 "member2" 100 "member3"

# 查询结果（按字典序排序）
ZRANGE equal:score 0 -1 WITHSCORES

# ============================================
# 测试24: 大数据量场景（性能测试）
# ============================================

# 批量添加数据（实际测试时可以添加更多）
ZADD perf:test 1 "m1" 2 "m2" 3 "m3" 4 "m4" 5 "m5" 6 "m6" 7 "m7" 8 "m8" 9 "m9" 10 "m10"

# 查询中间范围的数据
ZRANGEBYSCORE perf:test 3 7 WITHSCORES

# 统计数量
ZCARD perf:test

# ============================================
# 清理测试数据（可选）
# ============================================

# DEL leaderboard game:leaderboard kline:BTC:USDT:1m delay:queue test:pop set1 set2 union:result inter:result union:max union:min scan:test timeseries:hourly tasks cache:data temp:sorted:set equal:score perf:test
