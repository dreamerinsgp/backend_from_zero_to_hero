è§†é¢‘ï¼š
å½•åˆ¶ï¼šmysqlåŸºç¡€18_MVCC_è¯»è§†å›¾.mp4
æ—¥æœŸï¼š2026-01-26 21:23:47
å½•åˆ¶æ–‡ä»¶ï¼šhttps://meeting.tencent.com/crm/293EeD1we5


Q1: Read view åœ¨MVCCä¸­ä½œç”¨ï¼Ÿ
ReadView æ˜¯ InnoDB MVCC çš„å¿«ç…§æœºåˆ¶ï¼Œç”¨äºç¡®å®šäº‹åŠ¡å¯è§çš„æ•°æ®ç‰ˆæœ¬ã€‚

1) å¯è§æ€§åˆ¤æ–­
a. åˆ¤æ–­è¡Œçš„å“ªä¸ªç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡å¯è§
=ã€‹æ¯ä¸ªè¡Œå¯èƒ½æœ‰1ä¸ªæˆ–å¤šä¸ªç‰ˆæœ¬
=ã€‹æ¯ä¸ªäº‹åŠ¡åœ¨ç‰¹å®šæ—¶åˆ»åªèƒ½çœ‹åˆ°ä¸€ä¸ªç‰ˆæœ¬

b. æ£€æŸ¥è¡Œçš„äº‹åŠ¡IDæ˜¯å¦ç¬¦åˆReadviewè§„åˆ™
=ã€‹ å¦‚ä½•æ£€æŸ¥ï¼Ÿ 
=ã€‹ readviewè§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ

c. ä¸å¯è§æ—¶ï¼Œä»undo logæ„å»ºæ—§ç‰ˆæœ¬
=ã€‹æ˜¯æŒ‡çš„ä»€ä¹ˆå¯¹ä»€ä¹ˆä¸å¯è§ï¼Ÿ 


2ï¼‰éé˜»å¡è¯»å– 

3ï¼‰å¯é‡å¤è¯»
=ã€‹ åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡select çœ‹åˆ°ç›¸åŒçš„æ•°æ®ï¼Œå³ä½¿å…¶å®ƒäº‹åŠ¡åœ¨æœŸé—´æäº¤äº†ä¿®æ”¹


4ï¼‰å¿«ç…§éš”ç¦»
=ã€‹ æä¾›ä¸€è‡´çš„æ—¶é—´ç‚¹è§†å›¾ ï¼Ÿ 


Q2: Read Veiw æ•°æ®ç»“æ„ åŠæ ¸å¿ƒæ–¹æ³•ï¼Ÿ
æ•°æ®ç»“æ„ï¼š
1ï¼‰ m_low_limit_id: å¦‚æœä¸€è¡Œæ•°æ®çš„ä¿®æ”¹äº‹åŠ¡ID >= m_low_limit_id,é‚£ä¹ˆå½“å‰è¡Œçš„ä¿®æ”¹å¯¹å½“å‰è¯»å–äº‹åŠ¡ä¸å¯è§ï¼Œéœ€è¦ä»undo logæ„å»ºæ›´æ—©çš„ç‰ˆæœ¬ã€‚ 

2ï¼‰m_up_limit_id:  å¦‚æœä¸€è¡Œæ•°æ®çš„ä¿®æ”¹äº‹åŠ¡ID < m_up_limit_id,é‚£ä¹ˆå½“å‰è¡Œçš„ä¿®æ”¹å¯¹å½“å‰è¯»å–äº‹åŠ¡å¯è§ã€‚

3ï¼‰m_ids ï¼š å¿«ç…§åˆ›å»ºæ—¶è¿˜åœ¨æ´»è·ƒçš„è¯»å†™äº‹åŠ¡æ’åºæ•°ç»„
=ã€‹å¿«ç…§åˆ›å»ºæ—¶
=ã€‹æ´»è·ƒçš„äº‹åŠ¡ï¼š å°šæœªæäº¤æˆ–å›æ»šçš„äº‹åŠ¡ã€‚
=ã€‹ä¸ºä»€ä¹ˆåªè®°å½•è¯»å†™äº‹åŠ¡ï¼š å› ä¸ºåªè¯»äº‹åŠ¡å¯èƒ½æ²¡æœ‰äº‹åŠ¡IDï¼Œ åªæœ‰è¯»å†™äº‹åŠ¡æ‰æœ‰äº‹åŠ¡ID. 
=> ä¸ºä»€ä¹ˆæ˜¯æ’åºæ•°ç»„ï¼š ä¸ºäº†æ–¹ä¾¿åç»­äºŒåˆ†æŸ¥æ‰¾
const ids_t::value_type *p = m_ids.data();
return (!std::binary_search(p, p + m_ids.size(), id));

4ï¼‰m_creator_trx_id: æ‹¥æœ‰è¯¥ReadViewçš„äº‹åŠ¡

5ï¼‰m_low_limit_no: purgeç³»ç»Ÿç”¨äºåˆ¤æ–­å¯å®‰å…¨åˆ é™¤çš„undo log 

6) m_closed: åŸå­å¸ƒå°”æ ‡å¿—ï¼Œç”¨äºçº¿ç¨‹å®‰å…¨çš„è§†å›¾å…³é—­è·Ÿè¸ª

7ï¼‰m_view_list: é“¾è¡¨èŠ‚ç‚¹ï¼Œç”¨äºåœ¨äº‹åŠ¡ç³»ç»Ÿä¸­ç»´æŠ¤ ReadView åˆ—è¡¨

æ ¸å¿ƒæ–¹æ³•ï¼š
å¯è§æ€§æ£€æŸ¥é€»è¾‘
    changes_visible() æ–¹æ³•ä½¿ç”¨è¿™äº›å­—æ®µåˆ¤æ–­å¯è§æ€§ï¼š
    å¦‚æœ id < m_up_limit_id æˆ– id == m_creator_trx_id â†’ å¯è§
    å¦‚æœ id >= m_low_limit_id â†’ ä¸å¯è§
    å¦‚æœ id åœ¨ m_ids ä¸­ï¼ˆäºŒåˆ†æŸ¥æ‰¾ï¼‰â†’ ä¸å¯è§
    å¦åˆ™ â†’ å¯è§

Q3: å…·ä½“å®ä¾‹

**Setup:**
```sql
CREATE TABLE accounts (id INT PRIMARY KEY, balance DECIMAL(10,2));
INSERT INTO accounts VALUES (100, 1000.00);
COMMIT;
```

```
Time    Transaction    Action                          Status
----    -----------    -----------------------------   -----------
T1      TX-100         INSERT (balance=1000)           âœ… Committed
T2      TX-200         UPDATE (balance=1500)           âœ… Committed  
T3      TX-300         UPDATE (balance=2000)           ğŸ”„ Active (running)
T4      TX-READ        START TRANSACTION               ğŸ”„ Reading transaction
                       SELECT balance FROM accounts    â† ReadView created HERE
                       WHERE id=100;
T5      TX-400         UPDATE (balance=2500)           ğŸ”„ Started after ReadView
T6      TX-300         COMMIT                          âœ… Committed
T7      TX-400         COMMIT                          âœ… Committed
```

T4: Tx-read ï¼ˆåªè¯»äº‹åŠ¡ï¼‰ï¼Œé€šè¿‡æ‰§è¡Œ
select balacne from account where id = 100 ;  æ‡’åŠ è½½äº† Readview. 

m_low_limit_id = TX-400
m_up_limit_id =  TX-300  [å½“å‰æ´»è·ƒidä¸­çš„ï¼Œæœ€æ—©çš„id]
m_ids =  [TX-300]
m_creator_trx_id = TX-READ

é—®é¢˜ï¼šå“ªä¸ªç‰ˆæœ¬å¯¹å½“å‰çš„åªè¯»äº‹åŠ¡å¯è§ï¼Ÿ  
æ–¹æ¡ˆï¼šé‡‡ç”¨ readview visible æ–¹æ³•åˆ¤æ–­ï¼š
TX-300 å®ƒæ­£åœ¨æ´»è·ƒï¼Œä½äºm_ids,å®ƒæ˜¯å¯¹äºå½“å‰åªè¯»äº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚ ä»undo logæ„å»ºæ›´æ—©çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚ 
TX-200 ä¸å†m_idsï¼Œå¹¶ä¸”å®ƒå°äº m_low_limit_id, åŒæ—¶å®ƒè¿˜å°äº m_up_limit_id ã€‚ é‚£ä¹Ÿå°±æ˜¯è¯´Tx-200å®ƒå¯¹å½“å‰è¡Œçš„ä¿®æ”¹ï¼Œå¯¹äºTx-readæ˜¯å¯è§çš„ã€‚ 
é‚£ä¹ˆç»“æœï¼Œå°±æ˜¯1500. 
