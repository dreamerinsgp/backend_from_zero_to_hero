目标：
1. 理解MVCC定义
2. 理解其和锁的区别
3. 理解其原理

视频：
录制：mysql基础17_MVCC.mp4
日期：2026-01-26 18:35:15
录制文件：https://meeting.tencent.com/crm/KPRnV1omff


内容：
Q1: 定义
MultipleVersion concurrency control 

Q2：关系
它们都是用于支持并发的同时，保障数据的安全性

Q3：区别
MVCC通过多版本来实现类似锁的特性，但同时避免了维护锁带来的额外负载

Q4：原理
1）数据快照定义及其在MVCC中的作用？
数据快照（Snapshot） 是数据库在某一时刻对数据的完整视图，它代表了数据库在某一事务启动时刻的状态。

MVCC为每个事务维护了数据的多个版本（快照），确保即使数据正在被其他事务修改，当前事务依然能看到它开始时的稳定数据版本。每个事务都有自己的数据视图。 


2）一致性数据视图？
一致性数据视图 是指在某一事务内，事务能够看到的 一致且稳定的数据。 ACID. Consistency. 
保障：事务内所有读取操作都基于相同的视图。

3）多个事务能够看到一致性数据视图的意义？ 
确保每个事务在执行时，所读取的数据是稳定且一致的，即使其他事务正在并发执行。它避免了不同事务之间的数据污染和不一致性。


4）不同的事务在相同时间，相同的表中能看到不同的数据？ 
因为每个事务都有自己的数据视图。 


5）两种实现方式：
a: 乐观并发控制
b: 悲观并发控制

5）InnoDB实现MVCC的流程
第一步：给每个新事务分配一个事务ID
分配的时机？
当这个事务第一次读取任何数据的时候

第二步：undo record被写入到undo log ，然后这个事务的回滚指针会被指向该undo log record. 
发生的时机？
当一个record在当前事物内，发生变更的时候。


6）
动作：InnoDB 会比较一个record的事务ID和这个session下的读视图。
时机：当一个不同session读取 一个聚集key 索引记录时
问题1：当前session下的读视图？ 
    是指在 InnoDB 中，对于每个事务，数据库维护的一个“虚拟视图”或者“快照”。这个读视图定义了当前事务能看到哪些数据行。
    
读视图的作用是：
    它是为了确保 事务读取的数据是稳定一致的，即使其他事务正在修改或提交数据。
    每个事务都会根据 其启动时的事务 ID（或快照） 创建一个读视图。它表示在该事务开始时，事务能够看到哪些记录。

读视图的主要内容：
    事务ID列表：该事务能够看到的已提交事务的列表。这些事务的事务 ID 在读视图中是“可见”的。
    当前事务的 ID：这个事务本身不会看到它自己修改的记录，除非它自己提交后再读取。
    锁定信息：用于管理当前事务能看到的记录。

工作原理：
    InnoDB 会为每个读取操作（如 SELECT）创建一个 读视图，并将其与当前 事务 ID 和 其他正在运行事务的 ID 进行对比。
    如果事务修改了某行数据，但未提交，那么这行数据对当前事务（在读视图中）是 不可见的，即使它是由其他事务进行的修改。
    如果在读取时该数据已经被删除，除操作的事务 ID 小于当前事务的读视图中的事务 ID，那么该数据将 不可见，即使其并且删未被物理删除。
补充问题1：为什么要求事务 ID 小于当前事务的读视图中的事务 ID，才会不可见？


问题2：当前session? 
    当前 session 是指 当前正在执行的数据库会话，也就是当前正在执行 SQL 语句的数据库连接。

Q7：ReadView 和 Consistent Read 的关系？

它们不是同一个概念，但密切相关：

1. **Consistent Read (一致性读)**：
   - 这是一个**行为/特性**（What）
   - 指 InnoDB 使用 MVCC 向查询呈现数据库在某个时间点的快照
   - 是用户层面看到的效果：事务能看到一致且稳定的数据
   - 在 READ COMMITTED 和 REPEATABLE READ 隔离级别下，SELECT 语句默认使用一致性读

2. **ReadView (读视图)**：
   - 这是**实现机制/数据结构**（How）
   - 是 InnoDB 内部用来实现一致性读的数据结构
   - 包含以下信息：
     - `m_ids`: 当前活跃事务ID列表
     - `min_trx_id`: 最小活跃事务ID
     - `max_trx_id`: 下一个事务ID（分配上限）
     - `creator_trx_id`: 创建该ReadView的事务ID

3. **关系**：
   ```
   Consistent Read (一致性读)
        ↓ 通过
   ReadView (读视图) 机制实现
        ↓ 使用
   MVCC (多版本并发控制)
   ```

4. **工作流程**：
   - 当事务执行一致性读（如 SELECT）时，InnoDB 会：
     1. 创建或使用 ReadView（根据隔离级别）
     2. 读取数据行的版本链
     3. 使用 ReadView 判断哪个版本可见
     4. 返回可见的数据版本

5. **隔离级别的影响**：
   - **REPEATABLE READ**: 事务内第一次 SELECT 时创建 ReadView，后续 SELECT 复用同一个 ReadView
   - **READ COMMITTED**: 每次 SELECT 都创建新的 ReadView，看到最新的已提交数据

总结：Consistent Read 是"做什么"（提供一致的数据视图），ReadView 是"怎么做"（通过可见性判断机制实现）。


参考资源：
1. records在InnoDB中的物理结构：https://blog.jcole.us/2013/01/10/the-physical-structure-of-records-in-innodb/